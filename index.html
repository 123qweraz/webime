<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Web IME Pro | 流式智能版</title>
        <style>
            :root {
                --primary: #007aff;
                --bg: #f5f7fa;
                --text: #333;
            }
            body {
                font-family:
                    "PingFang SC", "Microsoft YaHei", system-ui, sans-serif;
                padding: 20px;
                background: var(--bg);
                display: flex;
                flex-direction: column;
                align-items: center;
                color: var(--text);
            }
            .container {
                background: white;
                padding: 30px;
                border-radius: 16px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
                width: 100%;
                max-width: 700px;
                display: flex;
                flex-direction: column;
                gap: 15px;
            }

            /* 结果展示区 */
            #output {
                width: 100%;
                min-height: 80px;
                padding: 15px;
                background: #fff;
                border: 2px dashed #e0e0e0;
                border-radius: 10px;
                font-size: 24px;
                line-height: 1.5;
                box-sizing: border-box;
                word-wrap: break-word;
                display: flex;
                align-items: center;
            }
            #output.empty {
                color: #bbb;
                font-size: 16px;
            }

            /* 状态栏 */
            #status {
                font-size: 14px;
                color: #666;
                height: 24px;
            }
            #status b {
                color: var(--primary);
                font-weight: 600;
            }

            /* 输入框 */
            #ime {
                width: 100%;
                font-size: 20px;
                padding: 14px;
                border: 2px solid #eee;
                border-radius: 10px;
                outline: none;
                box-sizing: border-box;
            }
            #ime:focus {
                border-color: var(--primary);
            }

            /* 候选词区域 - 重构为流式布局 */
            #candidates {
                padding: 12px;
                background: #f9f9f9;
                border-radius: 10px;
                max-height: 200px; /* 限制高度 */
                overflow-y: auto; /* 超出滚动 */
                display: flex;
                flex-wrap: wrap; /* 关键：流式折行 */
                gap: 8px;
                align-content: flex-start;
            }

            .cand {
                cursor: pointer;
                padding: 6px 14px;
                border-radius: 6px;
                font-size: 18px;
                background: white;
                border: 1px solid #ddd;
                user-select: none;
                transition: all 0.1s;
                display: flex;
                align-items: center;
                gap: 5px;
            }
            .cand:hover {
                background: var(--primary);
                color: white;
                border-color: var(--primary);
                transform: translateY(-1px);
            }

            /* 编号只在首排或前几个显示，或者作为辅助提示 */
            .cand .num {
                font-size: 11px;
                color: var(--primary);
                font-weight: bold;
                margin-right: 4px;
            }
            .cand:hover .num {
                color: rgba(255, 255, 255, 0.8);
            }

            /* 标签样式 */
            .tag {
                font-size: 9px;
                padding: 1px 3px;
                border-radius: 3px;
            }
            .tag-en {
                background: #e6f7ff;
                color: #007aff;
            }
            .tag-smart {
                background: #f6ffed;
                color: #52c41a;
            }
            .cand:hover .tag {
                background: rgba(255, 255, 255, 0.2);
                color: white;
            }

            .action-group {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            button {
                padding: 10px 24px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                background: #e1f5fe;
                color: #01579b;
                font-weight: bold;
            }

            /* Toast */
            #toast {
                position: fixed;
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 8px 20px;
                border-radius: 20px;
                font-size: 14px;
                opacity: 0;
                transition: 0.3s;
                pointer-events: none;
            }
            #toast.show {
                opacity: 1;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div id="output" class="empty">等待输入...</div>
            <div id="status">
                <span id="pinyin-display">词典加载中...</span>
            </div>
            <input
                id="ime"
                autofocus
                placeholder="直接输入拼音，鼠标点击或空格选词"
                autocomplete="off"
            />
            <div id="candidates"></div>
            <div class="action-group">
                <div style="font-size: 12px; color: #999">
                    <kbd>Ctrl+Enter</kbd> 复制 | <kbd>Space</kbd> 选首词
                </div>
                <button onclick="copyPureText()">复制文本</button>
            </div>
        </div>
        <div id="toast">已复制</div>

        <script>
            let DICT = {},
                EN_DICT = {},
                SYLLABLE_SET = new Set();
            let buffer = "",
                committedText = "",
                candidates = [];

            const imeInput = document.getElementById("ime");
            const candBox = document.getElementById("candidates");
            const statusText = document.getElementById("pinyin-display");
            const outputBox = document.getElementById("output");
            const toast = document.getElementById("toast");

            async function init() {
                try {
                    const [resPy, resEn] = await Promise.all([
                        fetch(`dict.json?t=${Date.now()}`),
                        fetch(`en_dict.json?t=${Date.now()}`),
                    ]);
                    DICT = await resPy.json();
                    EN_DICT = await resEn.json();
                    SYLLABLE_SET = new Set(Object.keys(DICT));
                    statusText.innerText = "词典已就绪 (所有匹配词已平铺)";
                } catch (e) {
                    statusText.innerHTML = "<b style='color:red'>加载失败</b>";
                }
            }

            function splitPinyin(str) {
                let res = [],
                    i = 0;
                while (i < str.length) {
                    let matched = false;
                    for (let len = 8; len >= 1; len--) {
                        let sub = str.substring(i, i + len);
                        if (SYLLABLE_SET.has(sub)) {
                            res.push(sub);
                            i += len;
                            matched = true;
                            break;
                        }
                    }
                    if (!matched) {
                        res.push(str[i]);
                        i++;
                    }
                }
                return res;
            }

            function update() {
                outputBox.innerText = committedText || "等待输入...";
                outputBox.classList.toggle("empty", !committedText);

                if (buffer.length > 0) {
                    const lower = buffer.toLowerCase();
                    const parts = splitPinyin(lower);
                    let pyResults = [],
                        smartResults = [],
                        enResults = [];

                    // 1. 拼音匹配 (高优先级)
                    if (DICT[parts[0]]) {
                        DICT[parts[0]].forEach((v) =>
                            pyResults.push({ val: v, type: "py" }),
                        );
                    }

                    // 2. 智能联搜 (中优先级)
                    if (parts.length >= 2) {
                        const w1 = DICT[parts[0]] ? DICT[parts[0]][0] : "";
                        const w2 = DICT[parts[1]] ? DICT[parts[1]][0] : "";
                        if (w1 && w2)
                            smartResults.push({
                                val: w1 + w2,
                                type: "smart",
                                len: parts[0].length + parts[1].length,
                            });
                    }

                    // 3. 英文辅助 (辅助优先级)
                    if (EN_DICT[lower]) {
                        EN_DICT[lower].forEach((v) => {
                            if (!pyResults.find((x) => x.val === v))
                                enResults.push({ val: v, type: "en" });
                        });
                    }

                    candidates = [...pyResults, ...smartResults, ...enResults];
                    if (candidates.length === 0)
                        candidates.push({ val: buffer, type: "raw" });
                    statusText.innerHTML = `输入: <b>${parts.join("'")}</b>`;
                } else {
                    statusText.innerText = "就绪";
                    candidates = [];
                }
                renderCandidates();
            }

            function renderCandidates() {
                // 直接显示所有候选词，不再进行分页
                candBox.innerHTML = candidates
                    .map((item, i) => {
                        let tag = "";
                        if (item.type === "en")
                            tag = '<span class="tag tag-en">En</span>';
                        if (item.type === "smart")
                            tag = '<span class="tag tag-smart">组</span>';
                        // 前9个保留数字提示，之后的纯点击
                        let numHint =
                            i < 9 ? `<span class="num">${i + 1}</span>` : "";
                        return `
                    <div class="cand" onclick="handleSelectByIndex(${i})">
                        ${numHint}${item.val}${tag}
                    </div>`;
                    })
                    .join("");
            }

            window.handleSelectByIndex = function (index) {
                const item = candidates[index];
                if (!item) return;

                if (item.type === "smart") {
                    buffer = buffer.substring(item.len);
                } else if (item.type === "en") {
                    buffer = "";
                } else {
                    const parts = splitPinyin(buffer.toLowerCase());
                    buffer = buffer.substring(parts[0].length);
                }
                committedText += item.val;
                update();
                imeInput.focus();
            };

            imeInput.addEventListener("keydown", (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
                    copyPureText();
                    e.preventDefault();
                    return;
                }
                if (e.key === "Enter") {
                    if (!buffer && committedText) copyPureText();
                    else if (buffer) {
                        committedText += buffer;
                        buffer = "";
                        update();
                    }
                    e.preventDefault();
                    return;
                }
                if (/^[a-z]$/i.test(e.key)) {
                    buffer += e.key;
                    update();
                    e.preventDefault();
                    return;
                }
                if (e.key === "Backspace") {
                    if (buffer) buffer = buffer.slice(0, -1);
                    else committedText = committedText.slice(0, -1);
                    update();
                    e.preventDefault();
                    return;
                }
                if (candidates.length > 0) {
                    if (e.key === " ") {
                        handleSelectByIndex(0);
                        e.preventDefault();
                    }
                    // 1-9 快捷选词依然保留，但界面更像普通按钮
                    if (/^[1-9]$/.test(e.key)) {
                        handleSelectByIndex(parseInt(e.key) - 1);
                        e.preventDefault();
                    }
                }
            });

            async function copyPureText() {
                if (!committedText) return;
                try {
                    await navigator.clipboard.writeText(committedText);
                    toast.classList.add("show");
                    setTimeout(() => toast.classList.remove("show"), 1500);
                } catch (err) {}
            }

            init();
        </script>
    </body>
</html>
