<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Web IME Pro | 搜索增强修复版</title>
        <style>
            :root {
                --primary: #007aff;
                --bg: #f2f2f7;
                --panel-bg: #ffffff;
                --text-main: #1d1d1f;
            }
            body {
                font-family:
                    system-ui,
                    -apple-system,
                    sans-serif;
                background: var(--bg);
                margin: 0;
                padding: 15px;
                min-height: 100vh;
                display: flex;
                justify-content: center;
                overflow: hidden;
            }
            .main-layout {
                display: flex;
                flex-direction: column;
                gap: 15px;
                width: 100%;
                max-width: 1500px;
                height: 96vh;
            }
            .toolbar {
                background: var(--panel-bg);
                padding: 12px 20px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                gap: 12px;
                flex-wrap: wrap;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            }
            .btn {
                padding: 8px 16px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                font-size: 13px;
                transition: 0.2s;
            }
            .btn-primary {
                background: #222;
                color: white;
            }
            .btn-toggle {
                background: #e5e5ea;
                color: #333;
            }
            .btn-toggle.active {
                background: var(--primary);
                color: white;
            }
            .btn-export {
                background: #28a745;
                color: white;
            }
            .btn-import {
                background: #ffc107;
                color: #212529;
            }
            .btn-baidu {
                background: #de0f17;
                color: white;
            }
            .btn-google {
                background: #4285f4;
                color: white;
            }

            .content-area {
                flex: 1;
                display: flex;
                gap: 15px;
                min-height: 0;
                position: relative;
            }
            .center-container {
                flex: 1;
                display: flex;
                flex-direction: column;
                gap: 15px;
            }

            .output-card {
                position: relative;
                background: white;
                padding: 25px;
                border-radius: 20px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
                height: 15%;
                min-height: 120px;
                max-height: 300px;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            #output-area {
                flex: 1;
                font-size: 26px;
                line-height: 1.5;
                outline: none;
                word-break: break-all;
                white-space: pre-wrap;
                overflow-y: auto;
                color: var(--text-main);
            }
            .cursor {
                display: inline-block;
                width: 2.5px;
                height: 30px;
                background: var(--primary);
                margin-left: 2px;
                vertical-align: middle;
                animation: blink 1s infinite;
            }
            @keyframes blink {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0;
                }
            }

            .action-btns {
                position: absolute;
                right: 20px;
                bottom: 20px;
                z-index: 10;
                display: flex;
                gap: 8px;
            }

            .input-card {
                background: white;
                padding: 20px;
                border-radius: 20px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
                flex: 1;
                min-height: 0;
                display: flex;
                flex-direction: column;
            }
            #buffer-display {
                font-size: 18px;
                color: var(--primary);
                font-weight: bold;
                min-height: 28px;
                margin: 10px 0 15px 0;
                display: flex;
                align-items: center;
                border-bottom: 2px solid #f0f0f0;
            }
            #main-candidates {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                min-height: 50px;
                margin-bottom: 12px;
            }
            .main-item {
                padding: 10px 16px;
                background: #f9f9f9;
                border-radius: 10px;
                cursor: pointer;
                font-size: 20px;
                border: 1px solid #eee;
                transition: 0.1s;
                min-width: 60px;
                text-align: center;
            }
            .main-item:hover {
                background: #f0f0f0;
                transform: translateY(-1px);
            }
            .main-item.is-pred {
                border: 1px dashed var(--primary);
                color: var(--primary);
            }

            #extended-section {
                display: none;
                flex-direction: column;
                margin-top: 15px;
                border-radius: 16px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                overflow: hidden;
                border: 2px solid transparent;
                transition: 0.3s;
                flex: 1;
                min-height: 0;
            }
            #extended-section.visible {
                display: flex;
            }
            #extended-section.active {
                border-color: var(--primary);
                background: #f0f7ff;
            }

            .panel-header {
                padding: 10px 15px;
                background: #f8f9fa;
                font-size: 12px;
                font-weight: bold;
                border-bottom: 1px solid #eee;
                display: flex;
                justify-content: space-between;
            }
            #side-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 8px;
                padding: 15px;
                overflow-y: auto;
                background: #f9fbff;
                flex: 1;
                min-height: 0;
            }
            .grid-item {
                background: #fff;
                border: 1px solid #eee;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                font-size: 16px;
                position: relative;
                min-height: 45px;
                padding: 4px;
                box-sizing: border-box;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            .grid-item:hover {
                background: #f5f5ff;
                transform: translateY(-1px);
            }
            .grid-key {
                font-family: monospace;
                font-size: 10px;
                color: #bbb;
                position: absolute;
                top: 2px;
                left: 4px;
            }

            .history-panel {
                flex: 0 0 280px;
                background: #fff;
                border-radius: 16px;
                padding: 15px;
                display: flex;
                flex-direction: column;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            }
            .history-list {
                flex: 1;
                overflow-y: auto;
                margin-top: 10px;
            }
            .history-item {
                position: relative;
                padding: 10px;
                border-bottom: 1px solid #f5f5f5;
                cursor: pointer;
                border-radius: 8px;
                margin-bottom: 5px;
                transition: background 0.2s;
            }
            .history-item:hover {
                background: #f9f9f9;
            }
            .history-text {
                word-break: break-all;
                margin-bottom: 4px;
                font-size: 14px;
                line-height: 1.4;
            }
            .copy-hint {
                float: right;
                font-size: 10px;
                color: var(--primary);
                opacity: 0;
                transition: opacity 0.2s;
            }

            #hidden-input {
                position: absolute;
                opacity: 0;
                pointer-events: none;
            }
            #toast {
                position: fixed;
                top: 70px;
                left: 50%;
                transform: translateX(-50%);
                background: #333;
                color: white;
                padding: 10px 24px;
                border-radius: 20px;
                opacity: 0;
                transition: 0.3s;
                z-index: 999;
                font-size: 14px;
            }
            @media (max-width: 1024px) {
                .history-panel {
                    display: none;
                }
            }
            @media (max-width: 767px) {
                .history-panel {
                    position: fixed;
                    right: -100%;
                    top: 0;
                    height: 100vh;
                    width: 80vw;
                    max-width: 350px;
                    z-index: 100;
                    transition: right 0.3s ease;
                    border-radius: 0;
                }
                .history-panel.visible {
                    right: 0;
                }
                .content-area.has-side-open {
                    filter: blur(5px);
                    pointer-events: none;
                }
                .output-card {
                    height: 20%;
                    min-height: 120px;
                    font-size: 22px;
                }
            }
            #overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.4);
                z-index: 99;
            }
            #overlay.visible {
                display: block;
            }
        </style>
    </head>
    <body>
        <div class="main-layout">
            <div class="toolbar">
                <div class="tool-group">
                    <button
                        id="rare-toggle"
                        class="btn btn-toggle"
                        onclick="toggleRare()"
                    >
                        生僻词：关闭
                    </button>
                    <button
                        id="english-toggle"
                        class="btn btn-toggle"
                        onclick="toggleEnglish()"
                    >
                        英文支持：关闭
                    </button>
                    <button
                        id="cizu-toggle"
                        class="btn btn-toggle"
                        onclick="toggleCizu()"
                    >
                        词组补全：关闭
                    </button>
                    <button
                        id="toggle-side"
                        class="btn btn-toggle"
                        onclick="toggleSidePanel()"
                    >
                        扩展候选：显示
                    </button>
                    <button
                        id="toggle-history"
                        class="btn btn-toggle"
                        onclick="toggleHistoryPanel()"
                    >
                        存档记录：隐藏
                    </button>
                    <button class="btn btn-export" onclick="exportHistory()">
                        导出存档
                    </button>
                    <button
                        class="btn btn-import"
                        onclick="
                            document.getElementById('import-input').click()
                        "
                    >
                        导入存档
                    </button>
                    <input
                        type="file"
                        id="import-input"
                        accept=".json"
                        style="display: none"
                        onchange="importHistory(event)"
                    />
                </div>
                <div
                    style="
                        flex: 1;
                        text-align: right;
                        font-size: 12px;
                        color: #888;
                    "
                >
                    <b>支持 Ctrl+B (百度) | Ctrl+G (Google)</b>
                </div>
            </div>
            <div class="content-area" id="content-area">
                <div
                    class="center-container"
                    onclick="document.getElementById('hidden-input').focus()"
                >
                    <div class="output-card">
                        <div id="output-area">
                            <span style="color: #ccc; font-size: 22px"
                                >已上屏文字将显示在这里...</span
                            >
                        </div>
                        <div class="action-btns">
                            <button
                                class="btn btn-baidu"
                                onclick="searchBaidu()"
                            >
                                百度
                            </button>
                            <button
                                class="btn btn-google"
                                onclick="searchGoogle()"
                            >
                                Google
                            </button>
                            <button
                                id="archive-btn"
                                class="btn btn-primary"
                                onclick="archiveAndCopy()"
                            >
                                归档并复制 (Ctrl+C)
                            </button>
                        </div>
                    </div>

                    <div class="input-card">
                        <div id="buffer-display">
                            <span
                                style="
                                    color: #ccc;
                                    font-weight: normal;
                                    font-size: 14px;
                                "
                                >等待输入...</span
                            >
                        </div>
                        <div id="main-candidates"></div>
                        <div id="extended-section">
                            <div class="panel-header">
                                <span>扩展候选 (Tab 键切换模式)</span>
                                <span id="side-status" style="opacity: 0.5"
                                    >NORMAL</span
                                >
                            </div>
                            <div id="side-grid"></div>
                        </div>
                        <input
                            type="text"
                            id="hidden-input"
                            autocomplete="off"
                        />
                    </div>
                </div>

                <div class="history-panel" id="history-panel">
                    <div
                        style="
                            font-size: 14px;
                            font-weight: bold;
                            display: flex;
                            justify-content: space-between;
                        "
                    >
                        存档记录
                        <a
                            href="#"
                            onclick="clearHistory()"
                            style="
                                font-size: 10px;
                                color: #ff3b30;
                                text-decoration: none;
                            "
                            >清空</a
                        >
                    </div>
                    <div class="history-list" id="history-list"></div>
                </div>
                <div id="overlay" onclick="closeAllPanels()"></div>
            </div>
        </div>
        <div id="toast">已就绪</div>

        <script>
            let DICT = {},
                LEVEL2 = null,
                LEVEL3 = null,
                EN_DICT = {},
                CIZU_DICT = {};
            let buffer = "",
                committed = "",
                isSideMode = false;
            let combinedCandidates = [];
            let HISTORY = JSON.parse(
                localStorage.getItem("ime_flow_v8") || "[]",
            );

            let rareEnabled = localStorage.getItem("rare_enabled") === "true";
            let englishEnabled =
                localStorage.getItem("english_enabled") === "true";
            let cizuEnabled = localStorage.getItem("cizu_enabled") === "true";

            let sideVisible = true;
            let historyVisible = true;

            const SIDE_KEYS = "123456789abcdefghijklmnopqrstuvwxyz".split("");
            const SYMBOLS = {
                1: "，",
                2: "。",
                3: "？",
                4: "！",
                5: "“",
                6: "”",
                7: "：",
                8: "；",
                9: "…",
            };
            let currentSidePage = 0;
            const CANDIDATES_PER_PAGE = 35;

            async function init() {
                try {
                    const promises = [fetch("dict.json").then((r) => r.json())];
                    if (englishEnabled)
                        promises.push(
                            fetch("en_dict.json").then((r) => r.json()),
                        );
                    else promises.push(Promise.resolve({}));
                    if (cizuEnabled)
                        promises.push(
                            fetch("cizu_dict.json").then((r) => r.json()),
                        );
                    else promises.push(Promise.resolve({}));
                    if (rareEnabled) {
                        promises.push(
                            fetch("level-2.json").then((r) => r.json()),
                        );
                        promises.push(
                            fetch("level-3.json").then((r) => r.json()),
                        );
                    } else {
                        promises.push(Promise.resolve(null));
                        promises.push(Promise.resolve(null));
                    }

                    const [d1, enDict, cizuDict, l2, l3] =
                        await Promise.all(promises);
                    DICT = d1;
                    EN_DICT = enDict;
                    CIZU_DICT = cizuDict;
                    LEVEL2 = l2;
                    LEVEL3 = l3;
                    updateAllToggleButtons();
                    updateHistoryUI();
                    update();
                } catch (e) {
                    console.error("词库加载失败", e);
                    showToast("部分词库加载失败");
                }
            }

            function updateAllToggleButtons() {
                updateToggleButton("rare-toggle", rareEnabled, "生僻词");
                updateToggleButton(
                    "english-toggle",
                    englishEnabled,
                    "英文支持",
                );
                updateToggleButton("cizu-toggle", cizuEnabled, "词组补全");
            }

            function updateToggleButton(id, enabled, label) {
                const btn = document.getElementById(id);
                btn.textContent = `${label}：${enabled ? "开启" : "关闭"}`;
                btn.classList.toggle("active", enabled);
            }

            window.toggleRare = async function () {
                rareEnabled = !rareEnabled;
                localStorage.setItem("rare_enabled", rareEnabled);
                await init();
            };
            window.toggleEnglish = async function () {
                englishEnabled = !englishEnabled;
                localStorage.setItem("english_enabled", englishEnabled);
                await init();
            };
            window.toggleCizu = async function () {
                cizuEnabled = !cizuEnabled;
                localStorage.setItem("cizu_enabled", cizuEnabled);
                await init();
            };

            function update() {
                const area = document.getElementById("output-area");
                area.innerHTML = committed || "";
                const cursor = document.createElement("span");
                cursor.className = "cursor";
                area.appendChild(cursor);

                const bufDisp = document.getElementById("buffer-display");
                bufDisp.innerHTML = buffer
                    ? `<span>${buffer}</span>`
                    : `<span style="color:#ccc; font-weight:normal; font-size:14px;">等待输入...</span>`;

                let list = [];
                if (buffer) {
                    const b = buffer.toLowerCase();
                    if (DICT[b])
                        DICT[b].forEach((v) =>
                            list.push({ text: v, weight: 1300, type: "zh" }),
                        );
                    if (cizuEnabled && CIZU_DICT[b])
                        CIZU_DICT[b].forEach((v) =>
                            list.push({
                                text: v,
                                weight: 1250,
                                type: "zh-cizu",
                            }),
                        );
                    if (rareEnabled && LEVEL2 && LEVEL2[b])
                        LEVEL2[b].forEach((v) =>
                            list.push({ text: v, weight: 900, type: "zh-l2" }),
                        );
                    if (rareEnabled && LEVEL3 && LEVEL3[b])
                        LEVEL3[b].forEach((v) =>
                            list.push({ text: v, weight: 700, type: "zh-l3" }),
                        );
                    if (englishEnabled && EN_DICT[b]) {
                        list.push({ text: b, weight: 850, type: "en" });
                        EN_DICT[b].forEach((zh) =>
                            list.push({ text: zh, weight: 800, type: "en-zh" }),
                        );
                    }
                    if (cizuEnabled) {
                        for (let pinyin in CIZU_DICT) {
                            if (pinyin.startsWith(b) && pinyin !== b) {
                                CIZU_DICT[pinyin].forEach((hanzi) =>
                                    list.push({
                                        text: hanzi,
                                        weight: 1100 - pinyin.length * 10,
                                        type: "cizu-pred",
                                    }),
                                );
                            }
                        }
                    }
                }

                const seen = new Set();
                combinedCandidates = list
                    .sort((a, b) => b.weight - a.weight)
                    .filter((x) => !seen.has(x.text) && seen.add(x.text));
                currentSidePage = 0;
                render();
                scrollOutput();
            }

            function render() {
                const mainItems = combinedCandidates.slice(0, 10);
                document.getElementById("main-candidates").innerHTML = mainItems
                    .map((item, i) => {
                        const keyDisplay = i === 9 ? "0" : i + 1;
                        const isPred = item.type.endsWith("-pred");
                        return `<div class="main-item ${isPred ? "is-pred" : ""}" onclick="selectIdx(${i})"><span style="font-size:10px;opacity:0.3;margin-right:4px;">${keyDisplay}</span>${item.text}</div>`;
                    })
                    .join("");

                const sideGrid = document.getElementById("side-grid");
                sideGrid.innerHTML = "";
                const sideItemsAll = combinedCandidates.slice(10);
                const totalPages = Math.ceil(
                    sideItemsAll.length / CANDIDATES_PER_PAGE,
                );
                const start = currentSidePage * CANDIDATES_PER_PAGE;
                const sideItems = sideItemsAll.slice(
                    start,
                    start + CANDIDATES_PER_PAGE,
                );

                document.getElementById("side-status").textContent =
                    sideItemsAll.length > 0
                        ? `第 ${currentSidePage + 1}/${totalPages} 页 (-/= 翻页)`
                        : "NORMAL";

                if (sideVisible && sideItems.length > 0) {
                    sideItems.forEach((item, i) => {
                        const globalIdx = start + i + 10;
                        const keyLabel = SIDE_KEYS[i]
                            ? SIDE_KEYS[i].toUpperCase()
                            : "";
                        const div = document.createElement("div");
                        div.className = "grid-item";
                        if (item.type.endsWith("-pred"))
                            div.style.border = "1px dashed var(--primary)";
                        div.onclick = () => selectIdx(globalIdx);
                        div.innerHTML = `${keyLabel ? `<span class="grid-key">${keyLabel}</span>` : ""}${item.text}`;
                        sideGrid.appendChild(div);
                    });
                }
                document
                    .getElementById("extended-section")
                    .classList.toggle("active", isSideMode);
            }

            function selectIdx(idx) {
                const item = combinedCandidates[idx];
                if (item) {
                    committed += item.text;
                    buffer = "";
                    isSideMode = false;
                    update();
                }
            }

            function scrollOutput() {
                const area = document.getElementById("output-area");
                area.scrollTop = area.scrollHeight;
                document.getElementById("hidden-input").focus();
            }

            window.searchBaidu = function () {
                const text = committed.trim();
                if (!text) return showToast("内容为空");
                window.open(
                    `https://www.baidu.com/s?wd=${encodeURIComponent(text)}`,
                    "_blank",
                );
            };

            window.searchGoogle = function () {
                const text = committed.trim();
                if (!text) return showToast("内容为空");
                window.open(
                    `https://www.google.com/search?q=${encodeURIComponent(text)}`,
                    "_blank",
                );
            };

            function toggleSidePanel() {
                sideVisible = !sideVisible;
                if (!sideVisible) isSideMode = false;
                updatePanelVisibility();
                render();
            }
            function toggleHistoryPanel() {
                historyVisible = !historyVisible;
                updatePanelVisibility();
            }
            function closeAllPanels() {
                historyVisible = false;
                updatePanelVisibility();
            }

            function updatePanelVisibility() {
                const extendedSection =
                    document.getElementById("extended-section");
                const historyPanel = document.getElementById("history-panel");
                const toggleSideBtn = document.getElementById("toggle-side");
                const toggleHistoryBtn =
                    document.getElementById("toggle-history");
                extendedSection.classList.toggle("visible", sideVisible);
                if (window.innerWidth > 767) {
                    historyPanel.style.display = historyVisible
                        ? "flex"
                        : "none";
                } else {
                    historyPanel.classList.toggle("visible", historyVisible);
                    document
                        .getElementById("overlay")
                        .classList.toggle("visible", historyVisible);
                }
                toggleSideBtn.classList.toggle("active", sideVisible);
                toggleHistoryBtn.classList.toggle("active", historyVisible);
            }

            document
                .getElementById("hidden-input")
                .addEventListener("keydown", (e) => {
                    const key = e.key;

                    // 1. 快捷键逻辑
                    if ((e.ctrlKey || e.metaKey) && key.toLowerCase() === "b") {
                        searchBaidu();
                        e.preventDefault();
                        return;
                    }
                    if ((e.ctrlKey || e.metaKey) && key.toLowerCase() === "g") {
                        searchGoogle();
                        e.preventDefault();
                        return;
                    }
                    if ((e.ctrlKey || e.metaKey) && key.toLowerCase() === "c") {
                        archiveAndCopy();
                        e.preventDefault();
                        return;
                    }
                    if (e.shiftKey && SYMBOLS[key]) {
                        committed += SYMBOLS[key];
                        update();
                        e.preventDefault();
                        return;
                    }
                    if (key === "Tab" && sideVisible) {
                        isSideMode = !isSideMode;
                        render();
                        e.preventDefault();
                        return;
                    }

                    // 2. 扩展区域翻页与字母选词优先判断
                    if (isSideMode && sideVisible) {
                        if (key === "-" && currentSidePage > 0) {
                            currentSidePage--;
                            render();
                            e.preventDefault();
                            return;
                        }
                        if (key === "=") {
                            const totalPages = Math.ceil(
                                combinedCandidates.slice(10).length /
                                    CANDIDATES_PER_PAGE,
                            );
                            if (currentSidePage < totalPages - 1)
                                currentSidePage++;
                            render();
                            e.preventDefault();
                            return;
                        }
                        // 重要修复：在扩展模式下，如果按下的是字母键，优先匹配扩展区按键
                        const sideIdx = SIDE_KEYS.indexOf(key.toLowerCase());
                        if (sideIdx !== -1) {
                            const globalIdx =
                                currentSidePage * CANDIDATES_PER_PAGE +
                                sideIdx +
                                10;
                            if (combinedCandidates[globalIdx]) {
                                selectIdx(globalIdx);
                                e.preventDefault(); // 阻止字母进入 buffer
                                return;
                            }
                        }
                    }

                    // 3. 数字选词逻辑 (不管是否 sideMode)
                    if (buffer && /^[0-9]$/.test(key)) {
                        const targetIdx =
                            isSideMode && sideVisible
                                ? key === "0"
                                    ? 19
                                    : parseInt(key) + 9
                                : key === "0"
                                  ? 9
                                  : parseInt(key) - 1;
                        if (combinedCandidates[targetIdx]) {
                            selectIdx(targetIdx);
                            e.preventDefault();
                        }
                        return;
                    }

                    // 4. 标准输入逻辑
                    if (key === "Backspace") {
                        if (buffer) buffer = buffer.slice(0, -1);
                        else if (committed) committed = committed.slice(0, -1);
                        update();
                        e.preventDefault();
                        return;
                    }
                    if (key === " ") {
                        if (buffer) selectIdx(0);
                        else committed += " ";
                        update();
                        e.preventDefault();
                        return;
                    }
                    if (key === "Enter") {
                        if (buffer) {
                            committed += buffer;
                            buffer = "";
                        } else committed += "\n";
                        update();
                        e.preventDefault();
                        return;
                    }
                    if (/^[a-z]$/.test(key)) {
                        buffer += key;
                        update();
                        e.preventDefault();
                        return;
                    }
                    if (
                        key.length === 1 &&
                        !buffer &&
                        !e.ctrlKey &&
                        !e.metaKey
                    ) {
                        committed += key;
                        update();
                        e.preventDefault();
                        return;
                    }
                });

            async function archiveAndCopy() {
                if (!committed) return;
                try {
                    await navigator.clipboard.writeText(committed);
                    HISTORY.unshift({
                        text: committed,
                        time: new Date().toLocaleTimeString(),
                    });
                    committed = "";
                    localStorage.setItem(
                        "ime_flow_v8",
                        JSON.stringify(HISTORY),
                    );
                    update();
                    updateHistoryUI();
                    showToast("归档成功并复制");
                } catch (err) {
                    showToast("复制失败");
                }
            }

            function updateHistoryUI() {
                const list = document.getElementById("history-list");
                list.innerHTML = HISTORY.map(
                    (h, index) => `
                    <div class="history-item" onclick="copyHistory('${index}')">
                        <div class="history-text">${h.text}</div>
                        <small style="opacity:0.5;">${h.time}</small>
                        <span class="copy-hint">点击复制</span>
                    </div>
                `,
                ).join("");
            }

            window.copyHistory = function (index) {
                const text = HISTORY[index].text;
                navigator.clipboard
                    .writeText(text)
                    .then(() => showToast("已复制"));
            };

            window.clearHistory = () => {
                if (confirm("清空？")) {
                    HISTORY = [];
                    localStorage.removeItem("ime_flow_v8");
                    updateHistoryUI();
                }
            };

            function showToast(msg) {
                const t = document.getElementById("toast");
                t.innerText = msg;
                t.style.opacity = 1;
                setTimeout(() => (t.style.opacity = 0), 2000);
            }

            init();
            window.onload = () =>
                document.getElementById("hidden-input").focus();
        </script>
    </body>
</html>
