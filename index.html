<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <title>Web IME Pro | 智能逻辑优化版</title>
        <style>
            :root {
                --primary: #007aff;
                --bg: #f2f2f7;
                --panel-bg: #ffffff;
                --item-bg: #f9f9f9;
                --item-border: #eee;
                --github-dark: #24292e;
            }
            body {
                font-family: system-ui, sans-serif;
                background: var(--bg);
                margin: 0;
                padding: 15px;
                height: 100vh;
                display: flex;
                justify-content: center;
                overflow: hidden;
            }
            .main-layout {
                display: flex;
                flex-direction: column;
                gap: 15px;
                width: 100%;
                max-width: 1900px;
                height: 96vh;
            }
            .toolbar {
                background: var(--panel-bg);
                padding: 10px 20px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                gap: 10px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            }
            .btn {
                padding: 6px 14px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 600;
                font-size: 12px;
                transition: 0.2s;
                display: flex;
                align-items: center;
                gap: 5px;
            }
            .btn-toggle {
                background: #e5e5ea;
                color: #333;
            }
            .btn-toggle.active {
                background: var(--primary);
                color: white;
            }
            .btn-github {
                background: var(--github-dark);
                color: white;
                text-decoration: none;
                margin-left: auto;
            }
            .content-area {
                flex: 1;
                display: flex;
                gap: 15px;
                min-height: 0;
                position: relative;
            }
            .resizer {
                width: 6px;
                background: #ddd;
                cursor: col-resize;
                z-index: 10;
            }
            .resizer-v {
                height: 6px;
                background: #ddd;
                cursor: row-resize;
                z-index: 10;
                margin: 2px 0;
            }
            .history-panel {
                flex: 0 0 260px;
                background: #fff;
                border-radius: 16px;
                padding: 15px;
                display: flex;
                flex-direction: column;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            }
            .center-container {
                flex: 1;
                display: flex;
                flex-direction: column;
                min-width: 400px;
                max-width: 1000px;
                margin: 0 auto;
            }
            .output-card {
                background: white;
                border-radius: 20px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
                position: relative;
                display: flex;
                flex-direction: column;
                min-height: 100px;
                border: 2px solid transparent;
            }
            .output-card.editing {
                border: 2px solid #ff9500;
            }
            #output-area {
                flex: 1;
                padding: 25px;
                font-size: 24px;
                line-height: 1.6;
                word-break: break-all;
                white-space: pre-wrap;
                overflow-y: auto;
                outline: none;
            }
            #output-area.locked::after {
                content: "";
                display: inline-block;
                width: 2px;
                height: 28px;
                background: var(--primary);
                vertical-align: middle;
                margin-left: 2px;
                animation: blink 1s infinite;
            }
            @keyframes blink {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0;
                }
            }
            .control-group {
                position: absolute;
                right: 15px;
                bottom: 15px;
                display: flex;
                gap: 8px;
                z-index: 100;
            }
            .input-card {
                background: white;
                padding: 20px;
                border-radius: 20px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                border: 3px solid transparent;
            }
            .input-card.tab-mode {
                border-color: var(--primary);
                background: #f0f7ff;
            }
            .input-status-bar {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
                border-bottom: 1px solid #eee;
                padding-bottom: 5px;
                min-height: 30px;
            }
            #buffer-display {
                font-size: 18px;
                color: var(--primary);
                font-weight: bold;
            }
            #main-candidates {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                overflow-y: auto;
            }
            .candidate-item {
                position: relative;
                padding: 10px 15px;
                background: var(--item-bg);
                border-radius: 10px;
                cursor: pointer;
                border: 1px solid var(--item-border);
                display: flex;
                flex-direction: column;
                align-items: center;
                min-width: 60px;
            }
            .cand-key {
                position: absolute;
                top: 2px;
                left: 4px;
                font-size: 10px;
                opacity: 0.5;
                color: var(--primary);
                font-weight: bold;
            }
            .cand-text {
                font-size: 22px;
                font-weight: 500;
            }
            .cand-desc {
                font-size: 11px;
                color: #888;
                margin-top: 4px;
            }
            #hidden-input {
                position: fixed;
                left: -999px;
                opacity: 0;
            }
            #toast {
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #333;
                color: white;
                padding: 8px 20px;
                border-radius: 20px;
                opacity: 0;
                transition: 0.3s;
                z-index: 999;
                pointer-events: none;
            }
        </style>
    </head>
    <body>
        <div class="main-layout">
            <div class="toolbar">
                <button
                    id="l-hist-btn"
                    class="btn btn-toggle"
                    onclick="toggleHistory()"
                >
                    历史记录
                </button>
                <button
                    id="l1-btn"
                    class="btn btn-toggle"
                    onclick="toggleLevel(1)"
                >
                    一级
                </button>
                <button
                    id="l2-btn"
                    class="btn btn-toggle"
                    onclick="toggleLevel(2)"
                >
                    二级
                </button>
                <button
                    id="l3-btn"
                    class="btn btn-toggle"
                    onclick="toggleLevel(3)"
                >
                    三级
                </button>
                <button
                    id="def-btn"
                    class="btn btn-toggle"
                    onclick="toggleDefaultChars()"
                >
                    常用字
                </button>
                <a
                    href="https://github.com/123qweraz/webime"
                    target="_blank"
                    class="btn btn-github"
                    >GitHub Star</a
                >
            </div>
            <div class="content-area">
                <div class="history-panel" id="history-panel">
                    <div
                        style="
                            font-weight: bold;
                            font-size: 14px;
                            border-bottom: 1px solid #eee;
                            padding-bottom: 8px;
                        "
                    >
                        最近归档
                    </div>
                    <div
                        id="history-list"
                        style="flex: 1; overflow-y: auto; margin-top: 10px"
                    ></div>
                </div>
                <div class="resizer" id="left-resizer"></div>
                <div class="center-container">
                    <div class="output-card" id="output-card">
                        <div
                            id="output-area"
                            class="locked"
                            spellcheck="false"
                            oninput="syncFromEditor()"
                        ></div>
                        <div class="control-group">
                            <button
                                id="edit-mode-btn"
                                class="btn btn-toggle"
                                onclick="toggleEditMode()"
                            >
                                锁定模式
                            </button>
                            <button
                                class="btn btn-toggle active"
                                style="background: #222"
                                onclick="archiveAndCopy()"
                            >
                                归档并复制
                            </button>
                        </div>
                    </div>
                    <div class="resizer-v" id="center-v-resizer"></div>
                    <div
                        class="input-card"
                        id="input-container"
                        onclick="focusHiddenInput()"
                    >
                        <div class="input-status-bar">
                            <div id="buffer-display"></div>
                            <div id="page-counter"></div>
                        </div>
                        <div id="main-candidates"></div>
                        <input
                            type="text"
                            id="hidden-input"
                            autocomplete="off"
                        />
                    </div>
                </div>
            </div>
        </div>
        <div id="toast"></div>

        <script>
            const DEFAULT_CHARS = [
                { text: "的" },
                { text: "一" },
                { text: "是" },
                { text: "了" },
                { text: "我" },
                { text: "不" },
                { text: "人" },
                { text: "在" },
                { text: "他" },
                { text: "有" },
            ];
            const PUNCS = {
                ",": "，",
                ".": "。",
                "!": "！",
                "?": "？",
                ";": "；",
                ":": "：",
                "(": "（",
                ")": "）",
                "[": "【",
                "]": "】",
            };
            let DB = { level1: {}, level2: {}, level3: {} };
            let settings = JSON.parse(
                localStorage.getItem("ime_settings") ||
                    '{"levels":[true, true, false], "history":true, "outputHeight":300, "showDefault":true}',
            );
            let buffer = "",
                committed = "",
                isTabMode = false,
                enFilter = "",
                isEditMode = false;
            let combinedCandidates = [],
                pageIndex = 0;
            const pageSize = 10;
            let HISTORY = JSON.parse(
                localStorage.getItem("ime_history_v18") || "[]",
            );
            const hInput = document.getElementById("hidden-input");
            const outputArea = document.getElementById("output-area");

            async function init() {
                document.getElementById("output-card").style.height =
                    settings.outputHeight + "px";
                document.getElementById("history-panel").style.display =
                    settings.history ? "flex" : "none";
                document
                    .getElementById("l-hist-btn")
                    .classList.toggle("active", settings.history);
                document
                    .getElementById("def-btn")
                    .classList.toggle("active", settings.showDefault);
                settings.levels.forEach((active, i) =>
                    document
                        .getElementById(`l${i + 1}-btn`)
                        .classList.toggle("active", active),
                );

                const load = async (num, dir, files) => {
                    const t = DB[`level${num}`];
                    for (const f of files) {
                        try {
                            const r = await fetch(`dicts/${dir}/${f}`);
                            if (!r.ok) continue;
                            const d = await r.json();
                            for (let k in d) {
                                let key = k.toLowerCase();
                                if (!t[key]) t[key] = [];
                                t[key] = t[key].concat(
                                    Array.isArray(d[k]) ? d[k] : [d[k]],
                                );
                            }
                        } catch (e) {}
                    }
                };
                await Promise.all([
                    load(1, "first_dict", [
                        "dict.json",
                        "cizu_dict.json",
                        "en_dict.json",
                    ]),
                    load(2, "second_dict", ["dict.json", "cizu_dict.json"]),
                    load(3, "third_dict", ["dict.json"]),
                ]);
                update();
                updateHistoryUI();
            }

            function update() {
                if (isEditMode) return;
                outputArea.innerText = committed;
                outputArea.scrollTop = outputArea.scrollHeight;

                if (buffer) {
                    const b = buffer.toLowerCase();
                    document.getElementById("buffer-display").innerText =
                        isTabMode
                            ? buffer + " [过滤: " + enFilter + "]"
                            : buffer;

                    let list = [];
                    // 门槛逻辑：短码用精确，长码用模糊
                    const isFuzzyMode = b.length >= 6;

                    const findInDict = (dict, weightBase) => {
                        if (isFuzzyMode) {
                            // 前缀模糊匹配逻辑
                            for (let key in dict) {
                                if (key.startsWith(b)) {
                                    let weight = weightBase;
                                    if (key === b) weight += 10000; // 完全匹配置顶
                                    weight -= (key.length - b.length) * 100; // 越短匹配度越高
                                    dict[key].forEach((i) => {
                                        list.push({
                                            text: i.char || i,
                                            desc:
                                                i.en ||
                                                (typeof i === "object"
                                                    ? i.en
                                                    : ""),
                                            w: weight,
                                        });
                                    });
                                }
                            }
                        } else {
                            // 精确匹配逻辑
                            if (dict[b]) {
                                dict[b].forEach((i) => {
                                    list.push({
                                        text: i.char || i,
                                        desc:
                                            i.en ||
                                            (typeof i === "object" ? i.en : ""),
                                        w: weightBase + 10000,
                                    });
                                });
                            }
                        }
                    };

                    if (settings.levels[0]) findInDict(DB.level1, 1500);
                    if (settings.levels[1]) findInDict(DB.level2, 1000);
                    if (settings.levels[2]) findInDict(DB.level3, 500);

                    const seen = new Set();
                    combinedCandidates = list
                        .sort((a, b) => b.w - a.w)
                        .filter((x) => !seen.has(x.text) && seen.add(x.text));

                    // 自动上屏逻辑：仅限模糊匹配模式且唯一匹配
                    if (
                        isFuzzyMode &&
                        combinedCandidates.length === 1 &&
                        !isTabMode
                    ) {
                        const word = combinedCandidates[0].text;
                        setTimeout(() => selectCandidate(word), 10);
                        return;
                    }
                } else {
                    document.getElementById("buffer-display").innerText = "";
                    combinedCandidates = settings.showDefault
                        ? DEFAULT_CHARS
                        : [];
                }
                render();
            }

            function render() {
                let display = combinedCandidates;
                if (isTabMode && enFilter) {
                    display = combinedCandidates.filter(
                        (i) =>
                            i.desc &&
                            i.desc
                                .toLowerCase()
                                .startsWith(enFilter.toLowerCase()),
                    );
                    if (display.length === 1) {
                        selectCandidate(display[0].text);
                        return;
                    }
                }
                const totalPages = Math.ceil(display.length / pageSize);
                document.getElementById("page-counter").innerText =
                    buffer && display.length > 0
                        ? `${pageIndex + 1} / ${totalPages || 1}`
                        : "";

                const pageData = display.slice(
                    pageIndex * pageSize,
                    (pageIndex + 1) * pageSize,
                );
                document.getElementById("main-candidates").innerHTML = pageData
                    .map(
                        (item, i) => `
                    <div class="candidate-item" onclick="selectCandidate('${item.text}')">
                        <span class="cand-key">${(i + 1) % 10}</span><div class="cand-text">${item.text}</div>
                        ${item.desc ? `<div class="cand-desc">${item.desc}</div>` : ""}
                    </div>`,
                    )
                    .join("");
            }

            function selectCandidate(t) {
                committed += t;
                resetInput();
                update();
            }
            function resetInput() {
                buffer = "";
                enFilter = "";
                isTabMode = false;
                pageIndex = 0;
                hInput.value = "";
            }

            hInput.addEventListener("keydown", (e) => {
                if (isEditMode) return;
                const key = e.key;
                if (PUNCS[key]) {
                    e.preventDefault();
                    if (buffer && combinedCandidates.length > 0)
                        committed += combinedCandidates[0].text;
                    committed += PUNCS[key];
                    resetInput();
                    update();
                    return;
                }
                if (buffer && !isTabMode) {
                    if (key === "=") {
                        e.preventDefault();
                        if (
                            (pageIndex + 1) * pageSize <
                            combinedCandidates.length
                        ) {
                            pageIndex++;
                            render();
                        }
                        return;
                    }
                    if (key === "-") {
                        e.preventDefault();
                        if (pageIndex > 0) {
                            pageIndex--;
                            render();
                        }
                        return;
                    }
                }
                if (key === "Tab") {
                    e.preventDefault();
                    if (buffer) {
                        isTabMode = !isTabMode;
                        enFilter = "";
                        update();
                    }
                    return;
                }
                if (isTabMode && buffer) {
                    if (/^[a-zA-Z]$/.test(key)) {
                        e.preventDefault();
                        enFilter += key.toLowerCase();
                        pageIndex = 0;
                        render();
                        return;
                    }
                    if (key === "Backspace") {
                        e.preventDefault();
                        if (enFilter) {
                            enFilter = enFilter.slice(0, -1);
                            render();
                        } else {
                            isTabMode = false;
                            update();
                        }
                        return;
                    }
                }
                if (/^[0-9]$/.test(key)) {
                    e.preventDefault();
                    const idx = key === "0" ? 9 : parseInt(key) - 1;
                    const list =
                        isTabMode && buffer
                            ? combinedCandidates.filter((c) =>
                                  c.desc?.toLowerCase().startsWith(enFilter),
                              )
                            : combinedCandidates;
                    const pageData = list.slice(
                        pageIndex * pageSize,
                        (pageIndex + 1) * pageSize,
                    );
                    if (pageData[idx]) selectCandidate(pageData[idx].text);
                } else if (key === "Enter") {
                    e.preventDefault();
                    if (buffer) {
                        committed += buffer;
                        resetInput();
                    } else {
                        committed += "\n";
                    }
                    update();
                } else if (key === "Backspace" && !buffer) {
                    e.preventDefault();
                    committed = committed.slice(0, -1);
                    update();
                } else if (key === " " && buffer) {
                    e.preventDefault();
                    const list =
                        isTabMode && buffer
                            ? combinedCandidates.filter((c) =>
                                  c.desc?.toLowerCase().startsWith(enFilter),
                              )
                            : combinedCandidates;
                    const pageData = list.slice(
                        pageIndex * pageSize,
                        (pageIndex + 1) * pageSize,
                    );
                    if (pageData[0]) selectCandidate(pageData[0].text);
                }
            });

            document.addEventListener("keydown", (e) => {
                const key = e.key.toLowerCase();
                if (e.ctrlKey && key === "e") {
                    e.preventDefault();
                    toggleEditMode();
                }
                if (e.ctrlKey && key === "c" && !isEditMode) {
                    e.preventDefault();
                    archiveAndCopy();
                }
                if (e.key === "Escape" && isEditMode) toggleEditMode();
            });

            hInput.addEventListener("input", () => {
                if (!isTabMode && !isEditMode) {
                    buffer = hInput.value.replace(/[^a-zA-Z]/g, "");
                    pageIndex = 0;
                    update();
                }
            });

            function toggleDefaultChars() {
                settings.showDefault = !settings.showDefault;
                document
                    .getElementById("def-btn")
                    .classList.toggle("active", settings.showDefault);
                saveSettings();
                update();
            }
            function toggleLevel(n) {
                settings.levels[n - 1] = !settings.levels[n - 1];
                document
                    .getElementById(`l${n}-btn`)
                    .classList.toggle("active", settings.levels[n - 1]);
                saveSettings();
                update();
            }
            function toggleHistory() {
                settings.history = !settings.history;
                document.getElementById("history-panel").style.display =
                    settings.history ? "flex" : "none";
                document
                    .getElementById("l-hist-btn")
                    .classList.toggle("active", settings.history);
                saveSettings();
            }
            function saveSettings() {
                localStorage.setItem("ime_settings", JSON.stringify(settings));
            }
            function toggleEditMode() {
                isEditMode = !isEditMode;
                outputArea.contentEditable = isEditMode;
                outputArea.classList.toggle("locked", !isEditMode);
                document.getElementById("edit-mode-btn").innerText = isEditMode
                    ? "编辑中 (ESC退出)"
                    : "锁定模式";
                document
                    .getElementById("edit-mode-btn")
                    .classList.toggle("active", isEditMode);
                document
                    .getElementById("output-card")
                    .classList.toggle("editing", isEditMode);
                if (!isEditMode) {
                    committed = outputArea.innerText;
                    resetInput();
                    update();
                    focusHiddenInput();
                } else {
                    outputArea.focus();
                }
            }
            function syncFromEditor() {
                if (isEditMode) committed = outputArea.innerText;
            }
            function archiveAndCopy() {
                if (!committed) return;
                navigator.clipboard.writeText(committed).then(() => {
                    HISTORY.unshift({
                        text: committed,
                        time: new Date().toLocaleTimeString(),
                    });
                    localStorage.setItem(
                        "ime_history_v18",
                        JSON.stringify(HISTORY.slice(0, 30)),
                    );
                    committed = "";
                    updateHistoryUI();
                    update();
                    showToast("已归档并复制");
                });
            }
            function updateHistoryUI() {
                document.getElementById("history-list").innerHTML = HISTORY.map(
                    (h) => `
                    <div style="padding:10px; border-bottom:1px solid #eee; cursor:pointer; font-size:12px;" onclick="committed+='${h.text}';update();">
                        <div style="color:#888; font-size:9px;">${h.time}</div>${h.text.substring(0, 30)}...
                    </div>`,
                ).join("");
            }
            function showToast(m) {
                const t = document.getElementById("toast");
                t.innerText = m;
                t.style.opacity = 1;
                setTimeout(() => (t.style.opacity = 0), 2000);
            }
            function focusHiddenInput() {
                if (!isEditMode) hInput.focus();
            }
            document.addEventListener("click", (e) => {
                if (isEditMode && outputArea.contains(e.target)) return;
                focusHiddenInput();
            });
            function makeResizableV(id, targetId) {
                const h = document.getElementById(id),
                    t = document.getElementById(targetId);
                h.addEventListener("mousedown", (e) => {
                    const startY = e.clientY,
                        startH = t.offsetHeight;
                    const drag = (ev) => {
                        const newH = startH + (ev.clientY - startY);
                        t.style.height = newH + "px";
                        settings.outputHeight = newH;
                    };
                    const stop = () => {
                        document.removeEventListener("mousemove", drag);
                        saveSettings();
                    };
                    document.addEventListener("mousemove", drag);
                    document.addEventListener("mouseup", stop);
                });
            }
            document.addEventListener("DOMContentLoaded", () => {
                makeResizableV("center-v-resizer", "output-card");
            });
            init();
            setInterval(focusHiddenInput, 1000);
        </script>
    </body>
</html>
