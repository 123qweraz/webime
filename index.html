<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <title>Web IME | 混沌灵感流 (默认关闭版)</title>
        <style>
            :root {
                --primary: #007aff;
                --bg: #ffffff;
                --history-bg: #f8f9fa;
            }
            body {
                font-family:
                    system-ui,
                    -apple-system,
                    sans-serif;
                background: var(--bg);
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 20px;
                min-height: 100vh;
                margin: 0;
                overflow-x: hidden;
            }

            .main-layout {
                display: flex;
                gap: 20px;
                width: 100%;
                max-width: 1100px;
                z-index: 100;
                margin-top: 20px;
            }
            .container {
                background: white;
                padding: 25px;
                border-radius: 20px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.06);
                flex: 2;
                position: relative;
            }

            /* 历史面板 */
            .history-panel {
                flex: 0.8;
                background: var(--history-bg);
                padding: 20px;
                border-radius: 20px;
                border: 1px solid #eee;
                max-height: 600px;
                overflow-y: auto;
            }
            .history-item {
                font-size: 14px;
                background: white;
                padding: 12px;
                border-radius: 10px;
                margin-bottom: 10px;
                border: 1px solid #eee;
                cursor: pointer;
                transition: 0.2s;
            }
            .history-item:hover {
                transform: translateX(5px);
                border-color: var(--primary);
            }

            #output-area {
                min-height: 140px;
                font-size: 28px;
                padding: 15px;
                background: #fff;
                border: 2px solid #f0f0f0;
                border-radius: 15px;
                margin-bottom: 15px;
                word-break: break-all;
                outline: none;
                line-height: 1.5;
            }
            #buffer-display {
                font-size: 20px;
                color: var(--primary);
                font-weight: bold;
                margin-bottom: 10px;
                height: 28px;
                letter-spacing: 1px;
            }

            #candidate-panel {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                max-height: 180px;
                overflow-y: auto;
                background: #fdfdfd;
                padding: 12px;
                border-radius: 12px;
                border: 1px solid #eee;
            }
            .candidate-item {
                cursor: pointer;
                padding: 10px 16px;
                background: white;
                border: 1px solid #ddd;
                border-radius: 8px;
                font-size: 20px;
            }
            .candidate-item:hover {
                background: var(--primary);
                color: white;
            }

            /* 混沌瀑布流 - 默认 Display: None */
            #inspiration-flow {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 260px;
                background: white;
                border-top: 1px solid #eee;
                overflow: hidden;
                z-index: 1;
                display: none;
                align-items: center;
            }
            #inspiration-flow.active {
                display: flex;
            }
            .flow-wrapper {
                display: flex;
                white-space: nowrap;
                animation: move-flow 100s linear infinite;
                will-change: transform;
            }
            .flow-item {
                font-size: 100px;
                font-weight: 900;
                color: #f5f5f5;
                padding: 0 70px;
                cursor: pointer;
                transition: 0.4s;
                user-select: none;
            }
            .flow-item:hover {
                color: var(--primary);
                transform: scale(1.1) rotate(2deg);
                z-index: 10;
            }

            @keyframes move-flow {
                0% {
                    transform: translateX(0);
                }
                100% {
                    transform: translateX(-50%);
                }
            }

            .action-bar {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: 20px;
            }
            .copy-btn {
                padding: 12px 30px;
                background: #222;
                color: white;
                border: none;
                border-radius: 10px;
                cursor: pointer;
                font-weight: bold;
            }
            #toast {
                position: fixed;
                top: 30px;
                background: #333;
                color: white;
                padding: 10px 30px;
                border-radius: 30px;
                opacity: 0;
                transition: 0.4s;
                z-index: 1000;
            }
        </style>
    </head>
    <body>
        <div class="main-layout">
            <div
                class="container"
                onclick="document.getElementById('hidden-input').focus()"
            >
                <div id="output-area"></div>
                <div id="buffer-display"></div>
                <input type="text" id="hidden-input" autocomplete="off" />
                <div id="candidate-panel"></div>

                <div class="action-bar">
                    <label
                        style="
                            font-size: 14px;
                            color: #666;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                        "
                    >
                        <input
                            type="checkbox"
                            id="flow-toggle"
                            onchange="toggleFlow(this.checked)"
                        />
                        <span>激活混沌灵感流</span>
                    </label>
                    <button class="copy-btn" onclick="archiveAndCopy()">
                        归档并复制 (Ctrl+C)
                    </button>
                </div>
            </div>

            <div class="history-panel">
                <div
                    style="
                        font-size: 14px;
                        font-weight: bold;
                        margin-bottom: 15px;
                        color: #333;
                    "
                >
                    创作存档记录
                </div>
                <div id="history-list"></div>
            </div>
        </div>

        <div id="inspiration-flow">
            <div class="flow-wrapper" id="flow-content"></div>
        </div>
        <div id="toast">已同步至剪切板</div>

        <script>
            let DICT = {},
                EN_DICT = {},
                ALL_CHARS = [];
            let buffer = "",
                committed = "";
            let currentCandidates = [];
            let HISTORY = JSON.parse(
                localStorage.getItem("ime_history") || "[]",
            );

            async function init() {
                try {
                    const [d1, d2] = await Promise.all([
                        fetch("dict.json").then((r) => r.json()),
                        fetch("en_dict.json").then((r) => r.json()),
                    ]);
                    DICT = d1;
                    EN_DICT = d2;
                    let charSet = new Set();
                    Object.values(DICT).forEach((list) => {
                        list.forEach((word) => {
                            if (word.length === 1) charSet.add(word);
                        });
                    });
                    ALL_CHARS = Array.from(charSet);

                    // 强制初始化 UI 状态
                    document.getElementById("flow-toggle").checked = false;
                    updateHistoryUI();
                } catch (e) {
                    console.error("Data error");
                }
            }

            function getChaosWord() {
                const len =
                    Math.random() > 0.7 ? (Math.random() > 0.5 ? 4 : 3) : 2;
                let word = "";
                for (let i = 0; i < len; i++) {
                    word +=
                        ALL_CHARS[Math.floor(Math.random() * ALL_CHARS.length)];
                }
                return word;
            }

            // 只有在勾选时才触发生成
            function toggleFlow(isActive) {
                const flow = document.getElementById("inspiration-flow");
                const content = document.getElementById("flow-content");

                if (isActive) {
                    // 激活时实时生成混沌池
                    let words = [];
                    for (let i = 0; i < 60; i++) words.push(getChaosWord());
                    words = words.sort(() => Math.random() - 0.5);
                    const html = words
                        .map(
                            (w) =>
                                `<div class="flow-item" onclick="capture('${w}')">${w}</div>`,
                        )
                        .join("");
                    content.innerHTML = html + html;

                    flow.classList.add("active");
                } else {
                    flow.classList.remove("active");
                    content.innerHTML = ""; // 关闭时清空 DOM，节省性能
                }
            }

            window.capture = function (w) {
                committed += w;
                update();
                showToast("捕获灵感: " + w);
            };

            function update() {
                document.getElementById("output-area").innerText = committed;
                document.getElementById("buffer-display").innerText = buffer;
                let list = [];
                if (buffer) {
                    const b = buffer.toLowerCase();
                    if (EN_DICT[b])
                        EN_DICT[b].forEach((v) =>
                            list.push({ text: v, weight: 100 }),
                        );
                    for (let key in DICT) {
                        if (key === b)
                            DICT[key].forEach((v) =>
                                list.push({ text: v, weight: 80 }),
                            );
                        else if (key.startsWith(b)) {
                            let w = 50 - (key.length - b.length);
                            DICT[key].forEach((v) =>
                                list.push({ text: v, weight: w }),
                            );
                        }
                    }
                }
                const sorted = list.sort((a, b) => b.weight - a.weight);
                const seen = new Set();
                currentCandidates = sorted.filter((item) => {
                    if (seen.has(item.text)) return false;
                    seen.add(item.text);
                    return true;
                });
                render();
            }

            function render() {
                const panel = document.getElementById("candidate-panel");
                panel.innerHTML = currentCandidates
                    .map(
                        (item, i) => `
                <div class="candidate-item" onclick="confirmSelect(${i})">
                    ${i < 9 ? `<span style="opacity:0.3;font-size:12px;margin-right:5px;">${i + 1}</span>` : ""}${item.text}
                </div>
            `,
                    )
                    .join("");
            }

            function confirmSelect(idx) {
                const item = currentCandidates[idx];
                if (!item) return;
                committed += item.text;
                buffer = "";
                update();
                document.getElementById("hidden-input").focus();
            }

            async function archiveAndCopy() {
                if (!committed) return;
                await navigator.clipboard.writeText(committed);
                HISTORY.unshift({
                    text: committed,
                    time: new Date().toLocaleTimeString(),
                });
                if (HISTORY.length > 50) HISTORY.pop();
                localStorage.setItem("ime_history", JSON.stringify(HISTORY));
                updateHistoryUI();
                committed = "";
                buffer = "";
                update();
                showToast("已归档并清空画布");
            }

            function updateHistoryUI() {
                const list = document.getElementById("history-list");
                if (HISTORY.length === 0) {
                    list.innerHTML = `<div style="color:#ccc;text-align:center;margin-top:20px;font-size:12px;">等待创作</div>`;
                    return;
                }
                list.innerHTML = HISTORY.map(
                    (item, i) => `
                <div class="history-item" onclick="restoreHistory(${i})">
                    <div style="font-size:10px;color:#bbb;margin-bottom:4px;">${item.time}</div>
                    ${item.text}
                </div>
            `,
                ).join("");
            }

            window.restoreHistory = function (idx) {
                committed = HISTORY[idx].text;
                update();
                showToast("内容已回填");
            };

            document
                .getElementById("hidden-input")
                .addEventListener("keydown", (e) => {
                    if (
                        (e.ctrlKey || e.metaKey) &&
                        (e.key === "c" || e.key === "Enter")
                    ) {
                        archiveAndCopy();
                        e.preventDefault();
                        return;
                    }
                    if (/^[a-z]$/i.test(e.key)) {
                        buffer += e.key.toLowerCase();
                        update();
                        e.preventDefault();
                    } else if (e.key === "Backspace") {
                        if (buffer) buffer = buffer.slice(0, -1);
                        else committed = committed.slice(0, -1);
                        update();
                        e.preventDefault();
                    } else if (e.key === " " && buffer) {
                        confirmSelect(0);
                        e.preventDefault();
                    } else if (buffer && /^[1-9]$/.test(e.key)) {
                        confirmSelect(parseInt(e.key) - 1);
                        e.preventDefault();
                    } else if (e.key === "Enter") {
                        if (buffer) {
                            committed += buffer;
                            buffer = "";
                            update();
                        }
                        e.preventDefault();
                    } else if (e.key.length === 1 && !buffer) {
                        committed += e.key;
                        update();
                        e.preventDefault();
                    }
                });

            function showToast(msg) {
                const t = document.getElementById("toast");
                t.innerText = msg;
                t.style.opacity = 1;
                setTimeout(() => (t.style.opacity = 0), 1500);
            }

            init();
            window.onload = () =>
                document.getElementById("hidden-input").focus();
        </script>
    </body>
</html>
