<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <title>Web IME Pro | 导入与长句修正版</title>
        <style>
            :root {
                --primary: #007aff;
                --bg: #f2f2f7;
                --panel-bg: #ffffff;
                --item-bg: #f9f9f9;
                --item-border: #eee;
                --github-dark: #24292e;
            }
            body {
                font-family: system-ui, sans-serif;
                background: var(--bg);
                margin: 0;
                padding: 15px;
                height: 100vh;
                display: flex;
                justify-content: center;
                overflow: hidden;
            }
            .main-layout {
                display: flex;
                flex-direction: column;
                gap: 15px;
                width: 100%;
                max-width: 1900px;
                height: 96vh;
            }
            .toolbar {
                background: var(--panel-bg);
                padding: 10px 20px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                gap: 10px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            }
            .btn {
                padding: 6px 14px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 600;
                font-size: 12px;
                transition: 0.2s;
                display: flex;
                align-items: center;
                gap: 5px;
            }
            .btn-toggle {
                background: #e5e5ea;
                color: #333;
            }
            .btn-toggle.active {
                background: var(--primary);
                color: white;
            }
            .btn-action {
                background: #34c759;
                color: white;
            }
            .btn-github {
                background: var(--github-dark);
                color: white;
                text-decoration: none;
                margin-left: auto;
            }
            .content-area {
                flex: 1;
                display: flex;
                gap: 15px;
                min-height: 0;
                position: relative;
            }
            .resizer {
                width: 6px;
                background: #ddd;
                cursor: col-resize;
                z-index: 10;
            }
            .resizer-v {
                height: 6px;
                background: #ddd;
                cursor: row-resize;
                z-index: 10;
                margin: 2px 0;
            }
            .history-panel {
                flex: 0 0 260px;
                background: #fff;
                border-radius: 16px;
                padding: 15px;
                display: flex;
                flex-direction: column;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            }
            .center-container {
                flex: 1;
                display: flex;
                flex-direction: column;
                min-width: 400px;
                max-width: 1000px;
                margin: 0 auto;
            }
            .output-card {
                background: white;
                border-radius: 20px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
                position: relative;
                display: flex;
                flex-direction: column;
                min-height: 100px;
                border: 2px solid transparent;
            }
            .output-card.editing {
                border: 2px solid #ff9500;
            }
            #output-area {
                flex: 1;
                padding: 25px;
                font-size: 24px;
                line-height: 1.6;
                word-break: break-all;
                white-space: pre-wrap;
                overflow-y: auto;
                outline: none;
            }
            .practice-hint {
                color: #d1d1d6;
                pointer-events: none;
            }
            #output-area.locked::after {
                content: "";
                display: inline-block;
                width: 2px;
                height: 28px;
                background: var(--primary);
                vertical-align: middle;
                margin-left: 2px;
                animation: blink 1s infinite;
            }
            @keyframes blink {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0;
                }
            }
            .control-group {
                position: absolute;
                right: 15px;
                bottom: 15px;
                display: flex;
                gap: 8px;
                z-index: 100;
            }
            .input-card {
                background: white;
                padding: 20px;
                border-radius: 20px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                border: 3px solid transparent;
                position: relative;
            }
            .input-card.tab-mode {
                border-color: var(--primary);
                background: #f0f7ff;
            }
            .input-status-bar {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
                border-bottom: 1px solid #eee;
                padding-bottom: 5px;
                min-height: 30px;
            }
            #buffer-display {
                font-size: 18px;
                color: var(--primary);
                font-weight: bold;
            }
            #main-candidates {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                overflow-y: auto;
            }
            .candidate-item {
                position: relative;
                padding: 10px 15px;
                background: var(--item-bg);
                border-radius: 10px;
                cursor: pointer;
                border: 1px solid var(--item-border);
                display: flex;
                flex-direction: column;
                align-items: center;
                min-width: 60px;
            }
            .cand-key {
                position: absolute;
                top: 2px;
                left: 4px;
                font-size: 10px;
                opacity: 0.5;
                color: var(--primary);
                font-weight: bold;
            }
            .cand-text {
                font-size: 22px;
                font-weight: 500;
            }
            .cand-desc {
                font-size: 11px;
                color: #888;
                margin-top: 4px;
            }
            #hidden-input {
                position: fixed;
                left: -999px;
                opacity: 0;
            }

            /* 修正模式输入框样式 */
            #correction-wrapper {
                position: absolute;
                bottom: 20px;
                left: 20px;
                right: 20px;
                background: white;
                box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.1);
                border-radius: 12px;
                padding: 15px;
                display: none;
                z-index: 200;
                border: 2px solid var(--primary);
            }
            #correction-input {
                width: 100%;
                font-size: 20px;
                border: none;
                outline: none;
                font-family: system-ui;
                color: #333;
                font-weight: 500;
                border-bottom: 1px solid #eee;
                padding-bottom: 5px;
            }
            .correction-tip {
                font-size: 12px;
                color: #888;
                margin-top: 8px;
                display: flex;
                justify-content: space-between;
            }

            #toast {
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #333;
                color: white;
                padding: 8px 20px;
                border-radius: 20px;
                opacity: 0;
                transition: 0.3s;
                z-index: 999;
                pointer-events: none;
            }
            /* 隐藏的文件输入 */
            #file-uploader {
                display: none;
            }
        </style>
    </head>
    <body>
        <div class="main-layout">
            <div class="toolbar">
                <button
                    id="l-hist-btn"
                    class="btn btn-toggle"
                    onclick="toggleHistory()"
                >
                    历史记录
                </button>
                <div
                    style="
                        width: 1px;
                        height: 20px;
                        background: #ddd;
                        margin: 0 5px;
                    "
                ></div>
                <button
                    class="btn btn-action"
                    onclick="document.getElementById('file-uploader').click()"
                >
                    导入词库
                </button>
                <button
                    id="l1-btn"
                    class="btn btn-toggle"
                    onclick="toggleLevel(1)"
                >
                    一级
                </button>
                <button
                    id="l2-btn"
                    class="btn btn-toggle"
                    onclick="toggleLevel(2)"
                >
                    二级
                </button>
                <button
                    id="l3-btn"
                    class="btn btn-toggle"
                    onclick="toggleLevel(3)"
                >
                    三级
                </button>
                <button
                    id="def-btn"
                    class="btn btn-toggle"
                    onclick="toggleDefaultChars()"
                >
                    常用字
                </button>

                <div
                    style="
                        width: 1px;
                        height: 20px;
                        background: #ddd;
                        margin: 0 5px;
                    "
                ></div>

                <button
                    id="practice-btn"
                    class="btn btn-toggle"
                    onclick="togglePracticeMode()"
                >
                    练习模式
                </button>

                <div
                    style="
                        width: 1px;
                        height: 20px;
                        background: #ddd;
                        margin: 0 5px;
                    "
                ></div>

                <input
                    type="file"
                    id="file-uploader"
                    accept=".json"
                    onchange="handleImportDict(this)"
                />

                <a
                    href="https://github.com/123qweraz/webime"
                    target="_blank"
                    class="btn btn-github"
                    >GitHub Star</a
                >
            </div>
            <div class="content-area">
                <div class="history-panel" id="history-panel">
                    <div
                        style="
                            font-weight: bold;
                            font-size: 14px;
                            border-bottom: 1px solid #eee;
                            padding-bottom: 8px;
                        "
                    >
                        最近归档
                    </div>
                    <div
                        id="history-list"
                        style="flex: 1; overflow-y: auto; margin-top: 10px"
                    ></div>
                </div>
                <div class="resizer" id="left-resizer"></div>
                <div class="center-container">
                    <div class="output-card" id="output-card">
                        <div
                            id="output-area"
                            class="locked"
                            spellcheck="false"
                            oninput="syncFromEditor()"
                        ></div>
                        <div class="control-group">
                            <button
                                id="edit-mode-btn"
                                class="btn btn-toggle"
                                onclick="toggleEditMode()"
                            >
                                锁定模式
                            </button>
                            <button
                                class="btn btn-toggle active"
                                style="background: #222"
                                onclick="archiveAndCopy()"
                            >
                                归档并复制
                            </button>
                        </div>
                    </div>
                    <div class="resizer-v" id="center-v-resizer"></div>
                    <div
                        class="input-card"
                        id="input-container"
                        onclick="focusHiddenInput()"
                    >
                        <div class="input-status-bar">
                            <div id="buffer-display"></div>
                            <div id="page-counter"></div>
                        </div>
                        <div id="main-candidates"></div>

                        <div id="correction-wrapper">
                            <input
                                type="text"
                                id="correction-input"
                                autocomplete="off"
                                placeholder="输入拼音短语，用空格分隔，如: ni hao"
                            />
                            <div class="correction-tip">
                                <span>支持长句输入 (空格分隔)</span>
                                <span>Enter 上屏 / Esc 取消</span>
                            </div>
                        </div>

                        <input
                            type="text"
                            id="hidden-input"
                            autocomplete="off"
                        />
                    </div>
                </div>
            </div>
        </div>
        <div id="toast"></div>

        <script>
            const DEFAULT_CHARS = [
                { text: "的" },
                { text: "一" },
                { text: "是" },
                { text: "了" },
                { text: "我" },
                { text: "不" },
                { text: "人" },
                { text: "在" },
                { text: "他" },
                { text: "有" },
            ];
            const PUNCS = {
                ",": "，",
                ".": "。",
                "!": "！",
                "?": "？",
                ";": "；",
                ":": "：",
                "(": "（",
                ")": "）",
                "[": "【",
                "]": "】",
            };

            // 词库结构
            let DB = { level1: {}, level2: {}, level3: {} };

            let settings = JSON.parse(
                localStorage.getItem("ime_settings") ||
                    '{"levels":[true, true, false], "history":true, "outputHeight":300, "showDefault":true}',
            );
            let buffer = "",
                committed = "",
                isTabMode = false,
                enFilter = "",
                isEditMode = false;

            // 新增状态
            let isPracticeMode = false;
            let practiceTargetText = "";
            let isCorrectionMode = false;

            let combinedCandidates = [],
                pageIndex = 0;
            const pageSize = 10;
            let HISTORY = JSON.parse(
                localStorage.getItem("ime_history_v18") || "[]",
            );

            const hInput = document.getElementById("hidden-input");
            const outputArea = document.getElementById("output-area");
            const correctionWrapper =
                document.getElementById("correction-wrapper");
            const correctionInput = document.getElementById("correction-input");

            async function init() {
                applySettings();
                const load = async (num, dir, files) => {
                    const t = DB[`level${num}`];
                    for (const f of files) {
                        try {
                            const r = await fetch(`dicts/${dir}/${f}`);
                            if (!r.ok) continue;
                            const d = await r.json();
                            mergeIntoDict(t, d);
                        } catch (e) {}
                    }
                };
                await Promise.all([
                    load(1, "first_dict", [
                        "dict.json",
                        "dict_cizu.json",
                        "dict_enlt5s.json",
                        "dict_5_10s.json",
                    ]),
                    load(2, "second_dict", [
                        "level-2_char_en.json",
                        "cizu_dict.json",
                    ]),
                    load(3, "third_dict", ["level-3_char_en.json"]),
                ]);
                update();
                updateHistoryUI();
            }

            // 统一的合并词库逻辑
            function mergeIntoDict(targetDict, newDict) {
                for (let k in newDict) {
                    let key = k.toLowerCase();
                    if (!targetDict[key]) targetDict[key] = [];
                    // 去重合并
                    const newItems = Array.isArray(newDict[k])
                        ? newDict[k]
                        : [newDict[k]];
                    // 简单合并，实际应用可以做更复杂的去重
                    targetDict[key] = targetDict[key].concat(newItems);
                }
            }

            function applySettings() {
                document.getElementById("output-card").style.height =
                    settings.outputHeight + "px";
                document.getElementById("history-panel").style.display =
                    settings.history ? "flex" : "none";
                document
                    .getElementById("l-hist-btn")
                    .classList.toggle("active", settings.history);
                document
                    .getElementById("def-btn")
                    .classList.toggle("active", settings.showDefault);
                settings.levels.forEach((active, i) =>
                    document
                        .getElementById(`l${i + 1}-btn`)
                        .classList.toggle("active", active),
                );
            }

            // --- 词库导入功能 ---
            function handleImportDict(input) {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const json = JSON.parse(e.target.result);
                        // 将导入的词库默认合并到 Level 1 (最高优先级)
                        mergeIntoDict(DB.level1, json);
                        showToast(`成功导入词库: ${file.name}`);
                        input.value = ""; // 重置 input 以便允许再次导入同名文件
                        update(); // 刷新可能显示的候选词
                    } catch (err) {
                        alert("词库文件格式错误，请确保是标准的 JSON 格式。");
                        console.error(err);
                    }
                };
                reader.readAsText(file);
            }

            function update() {
                if (isEditMode) return;

                // 练习模式渲染
                if (isPracticeMode && practiceTargetText) {
                    if (practiceTargetText.startsWith(committed)) {
                        const remaining = practiceTargetText.substring(
                            committed.length,
                        );
                        outputArea.innerHTML =
                            escapeHtml(committed) +
                            `<span class="practice-hint">${escapeHtml(remaining)}</span>`;
                    } else {
                        outputArea.innerText = committed; // 输错不显示后续提示
                    }
                    // 自动跳下一组
                    if (committed === practiceTargetText) {
                        setTimeout(() => {
                            committed = "";
                            generatePracticeText();
                            update();
                            showToast("不错！下一组");
                        }, 200);
                    }
                } else {
                    outputArea.innerText = committed;
                }
                outputArea.scrollTop = outputArea.scrollHeight;

                // 候选词逻辑
                if (buffer) {
                    const b = buffer.toLowerCase();
                    document.getElementById("buffer-display").innerText =
                        isTabMode
                            ? buffer + " [过滤: " + enFilter + "]"
                            : buffer;
                    let list = [];
                    const isFuzzyMode = b.length >= 6;

                    const findInDict = (dict, weightBase) => {
                        if (isFuzzyMode) {
                            for (let key in dict) {
                                if (key.startsWith(b)) {
                                    let weight = weightBase;
                                    if (key === b) weight += 10000;
                                    weight -= (key.length - b.length) * 100;
                                    dict[key].forEach((i) => {
                                        list.push({
                                            text: i.char || i,
                                            desc:
                                                i.en ||
                                                (typeof i === "object"
                                                    ? i.en
                                                    : ""),
                                            w: weight,
                                        });
                                    });
                                }
                            }
                        } else if (dict[b]) {
                            dict[b].forEach((i) => {
                                list.push({
                                    text: i.char || i,
                                    desc:
                                        i.en ||
                                        (typeof i === "object" ? i.en : ""),
                                    w: weightBase + 10000,
                                });
                            });
                        }
                    };

                    if (settings.levels[0]) findInDict(DB.level1, 1500);
                    if (settings.levels[1]) findInDict(DB.level2, 1000);
                    if (settings.levels[2]) findInDict(DB.level3, 500);

                    const seen = new Set();
                    combinedCandidates = list
                        .sort((a, b) => b.w - a.w)
                        .filter((x) => !seen.has(x.text) && seen.add(x.text));

                    if (
                        isFuzzyMode &&
                        combinedCandidates.length === 1 &&
                        !isTabMode
                    ) {
                        const word = combinedCandidates[0].text;
                        setTimeout(() => selectCandidate(word), 10);
                        return;
                    }
                } else {
                    document.getElementById("buffer-display").innerText = "";
                    combinedCandidates = settings.showDefault
                        ? DEFAULT_CHARS
                        : [];
                }
                render();
            }

            function escapeHtml(text) {
                return text
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;");
            }

            function render() {
                let display = combinedCandidates;
                if (isTabMode && enFilter) {
                    display = combinedCandidates.filter(
                        (i) =>
                            i.desc &&
                            i.desc
                                .toLowerCase()
                                .startsWith(enFilter.toLowerCase()),
                    );
                    if (display.length === 1) {
                        selectCandidate(display[0].text);
                        return;
                    }
                }
                const totalPages = Math.ceil(display.length / pageSize);
                document.getElementById("page-counter").innerText =
                    buffer && display.length > 0
                        ? `${pageIndex + 1} / ${totalPages || 1}`
                        : "";
                const pageData = display.slice(
                    pageIndex * pageSize,
                    (pageIndex + 1) * pageSize,
                );
                document.getElementById("main-candidates").innerHTML = pageData
                    .map(
                        (item, i) => `
                    <div class="candidate-item" onclick="selectCandidate('${item.text}')">
                        <span class="cand-key">${(i + 1) % 10}</span><div class="cand-text">${item.text}</div>
                        ${item.desc ? `<div class="cand-desc">${item.desc}</div>` : ""}
                    </div>`,
                    )
                    .join("");
            }

            function selectCandidate(t) {
                committed += t;
                resetInput();
                update();
            }

            function resetInput() {
                buffer = "";
                enFilter = "";
                isTabMode = false;
                pageIndex = 0;
                hInput.value = "";
            }

            // --- 事件监听 ---
            hInput.addEventListener("keydown", (e) => {
                if (isEditMode || isCorrectionMode) return; // 模式排他
                const key = e.key;

                // Ctrl+I 进入长句/修正模式
                if (e.ctrlKey && key.toLowerCase() === "i") {
                    e.preventDefault();
                    enterCorrectionMode();
                    return;
                }

                if (PUNCS[key]) {
                    e.preventDefault();
                    if (buffer && combinedCandidates.length > 0)
                        committed += combinedCandidates[0].text;
                    committed += PUNCS[key];
                    resetInput();
                    update();
                    return;
                }

                // 翻页逻辑
                if (buffer && !isTabMode) {
                    if (key === "=") {
                        e.preventDefault();
                        if (
                            (pageIndex + 1) * pageSize <
                            combinedCandidates.length
                        ) {
                            pageIndex++;
                            render();
                        }
                        return;
                    }
                    if (key === "-") {
                        e.preventDefault();
                        if (pageIndex > 0) {
                            pageIndex--;
                            render();
                        }
                        return;
                    }
                }

                if (key === "Tab") {
                    e.preventDefault();
                    if (buffer) {
                        isTabMode = !isTabMode;
                        enFilter = "";
                        update();
                    }
                    return;
                }

                // Tab 过滤模式
                if (isTabMode && buffer) {
                    if (/^[a-zA-Z]$/.test(key)) {
                        e.preventDefault();
                        enFilter += key.toLowerCase();
                        pageIndex = 0;
                        render();
                        return;
                    }
                    if (key === "Backspace") {
                        e.preventDefault();
                        if (enFilter) {
                            enFilter = enFilter.slice(0, -1);
                            render();
                        } else {
                            isTabMode = false;
                            update();
                        }
                        return;
                    }
                }

                // 数字选词
                if (/^[0-9]$/.test(key)) {
                    e.preventDefault();
                    const idx = key === "0" ? 9 : parseInt(key) - 1;
                    const list =
                        isTabMode && buffer
                            ? combinedCandidates.filter((c) =>
                                  c.desc?.toLowerCase().startsWith(enFilter),
                              )
                            : combinedCandidates;
                    const pageData = list.slice(
                        pageIndex * pageSize,
                        (pageIndex + 1) * pageSize,
                    );
                    if (pageData[idx]) selectCandidate(pageData[idx].text);
                }
                // 回车上屏
                else if (key === "Enter") {
                    e.preventDefault();
                    if (buffer) {
                        committed += buffer;
                        resetInput();
                    } else {
                        committed += "\n";
                    }
                    update();
                }
                // 删除键
                else if (key === "Backspace" && !buffer) {
                    e.preventDefault();
                    committed = committed.slice(0, -1);
                    update();
                }
                // 空格首选
                else if (key === " " && buffer) {
                    e.preventDefault();
                    const list =
                        isTabMode && buffer
                            ? combinedCandidates.filter((c) =>
                                  c.desc?.toLowerCase().startsWith(enFilter),
                              )
                            : combinedCandidates;
                    const pageData = list.slice(
                        pageIndex * pageSize,
                        (pageIndex + 1) * pageSize,
                    );
                    if (pageData[0]) selectCandidate(pageData[0].text);
                }
            });

            document.addEventListener("keydown", (e) => {
                const key = e.key.toLowerCase();
                // Ctrl+E 切换编辑
                if (e.ctrlKey && key === "e") {
                    e.preventDefault();
                    toggleEditMode();
                    return;
                }
                // Ctrl+C 复制
                if (e.ctrlKey && key === "c") {
                    if (!isEditMode && !isCorrectionMode) {
                        e.preventDefault();
                        archiveAndCopy();
                    }
                    return;
                }
                if (e.key === "Escape") {
                    if (isEditMode) toggleEditMode();
                    if (isCorrectionMode) exitCorrectionMode(false);
                }
            });

            hInput.addEventListener("input", () => {
                if (!isTabMode && !isEditMode) {
                    buffer = hInput.value.replace(/[^a-zA-Z]/g, "");
                    pageIndex = 0;
                    update();
                }
            });

            // --- 修正/长句模式逻辑 (核心更新) ---
            function enterCorrectionMode() {
                isCorrectionMode = true;
                correctionWrapper.style.display = "block";
                correctionInput.value = buffer; // 预填充当前的 buffer
                correctionInput.focus();
                // 将光标移到末尾
                correctionInput.setSelectionRange(
                    correctionInput.value.length,
                    correctionInput.value.length,
                );
            }

            function exitCorrectionMode(save) {
                isCorrectionMode = false;
                correctionWrapper.style.display = "none";
                if (save) {
                    const raw = correctionInput.value.trim();
                    if (raw) {
                        const result = convertSentence(raw);
                        committed += result;
                        resetInput(); // 清空原有 buffer，因为我们已经处理完了
                        update();
                    }
                }
                focusHiddenInput();
            }

            // 核心：把 "ni hao ma" 转换成 "你好吗"
            function convertSentence(inputStr) {
                // 1. 按空格分割
                const segments = inputStr.split(/\s+/);
                let finalStr = "";

                // 2. 遍历每个片段
                for (const seg of segments) {
                    if (!seg) continue;
                    // 纯字母视作拼音，否则直接保留原样（比如用户输了标点）
                    if (/^[a-zA-Z]+$/.test(seg)) {
                        const lowSeg = seg.toLowerCase();
                        // 查找候选词 (Level 1 -> 2 -> 3)
                        let best = null;

                        // 辅助查找函数
                        const getBest = (dict) => {
                            if (dict[lowSeg]) return dict[lowSeg][0]; // 取第一个
                            return null;
                        };

                        if (settings.levels[0]) best = getBest(DB.level1);
                        if (!best && settings.levels[1])
                            best = getBest(DB.level2);
                        if (!best && settings.levels[2])
                            best = getBest(DB.level3);

                        if (best) {
                            finalStr +=
                                typeof best === "object" ? best.char : best;
                        } else {
                            finalStr += seg; // 没找到就保留原文
                        }
                    } else {
                        finalStr += seg;
                    }
                }
                return finalStr;
            }

            correctionInput.addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    exitCorrectionMode(true);
                } else if (e.key === "Escape") {
                    e.preventDefault();
                    exitCorrectionMode(false);
                } else if (e.ctrlKey && e.key.toLowerCase() === "i") {
                    e.preventDefault();
                    // 允许连按 Ctrl+I 触发确认
                    exitCorrectionMode(true);
                }
            });

            // --- 练习模式逻辑 (数量优化) ---
            function togglePracticeMode() {
                isPracticeMode = !isPracticeMode;
                document
                    .getElementById("practice-btn")
                    .classList.toggle("active", isPracticeMode);

                if (isPracticeMode) {
                    committed = "";
                    generatePracticeText();
                    showToast("进入练习模式");
                } else {
                    practiceTargetText = "";
                    committed = "";
                    showToast("退出练习模式");
                }
                update();
                focusHiddenInput();
            }

            function generatePracticeText() {
                let allWords = [];
                const collect = (dict) => {
                    for (let k in dict) {
                        dict[k].forEach((item) => {
                            const text =
                                typeof item === "object" ? item.char : item;
                            if (text.length > 1) allWords.push(text);
                        });
                    }
                };
                if (settings.levels[0]) collect(DB.level1);
                if (settings.levels[1]) collect(DB.level2);
                if (settings.levels[2]) collect(DB.level3);

                if (allWords.length === 0) {
                    practiceTargetText = "词库为空，请先加载或导入词库。";
                    return;
                }

                // 优化：只生成 5 组词
                const COUNT = 5;
                let result = "";
                for (let i = 0; i < COUNT; i++) {
                    const rand =
                        allWords[Math.floor(Math.random() * allWords.length)];
                    result += rand + "，";
                }
                result = result.slice(0, -1) + "。";
                practiceTargetText = result;
            }

            // --- 常规设置与工具函数 ---
            function toggleDefaultChars() {
                settings.showDefault = !settings.showDefault;
                document
                    .getElementById("def-btn")
                    .classList.toggle("active", settings.showDefault);
                saveSettings();
                update();
            }
            function toggleLevel(n) {
                settings.levels[n - 1] = !settings.levels[n - 1];
                document
                    .getElementById(`l${n}-btn`)
                    .classList.toggle("active", settings.levels[n - 1]);
                saveSettings();
                update();
            }
            function toggleHistory() {
                settings.history = !settings.history;
                document.getElementById("history-panel").style.display =
                    settings.history ? "flex" : "none";
                document
                    .getElementById("l-hist-btn")
                    .classList.toggle("active", settings.history);
                saveSettings();
            }
            function saveSettings() {
                localStorage.setItem("ime_settings", JSON.stringify(settings));
            }
            function toggleEditMode() {
                isEditMode = !isEditMode;
                outputArea.contentEditable = isEditMode;
                outputArea.classList.toggle("locked", !isEditMode);
                const btn = document.getElementById("edit-mode-btn");
                btn.innerText = isEditMode ? "编辑中 (ESC退出)" : "锁定模式";
                btn.classList.toggle("active", isEditMode);
                document
                    .getElementById("output-card")
                    .classList.toggle("editing", isEditMode);
                if (isEditMode) {
                    outputArea.focus();
                    if (window.getSelection && document.createRange) {
                        const range = document.createRange();
                        range.selectNodeContents(outputArea);
                        range.collapse(false);
                        const sel = window.getSelection();
                        sel.removeAllRanges();
                        sel.addRange(range);
                    }
                } else {
                    committed = outputArea.innerText;
                    resetInput();
                    update();
                    focusHiddenInput();
                }
            }
            function syncFromEditor() {
                if (isEditMode) committed = outputArea.innerText;
            }
            function archiveAndCopy() {
                if (!committed) return;
                navigator.clipboard.writeText(committed).then(() => {
                    HISTORY.unshift({
                        text: committed,
                        time: new Date().toLocaleTimeString(),
                    });
                    localStorage.setItem(
                        "ime_history_v18",
                        JSON.stringify(HISTORY.slice(0, 30)),
                    );
                    committed = "";
                    updateHistoryUI();
                    update();
                    showToast("已归档并复制");
                });
            }
            function updateHistoryUI() {
                document.getElementById("history-list").innerHTML = HISTORY.map(
                    (h) =>
                        `<div style="padding:10px; border-bottom:1px solid #eee; cursor:pointer; font-size:12px;" onclick="committed+='${h.text}';update();"><div style="color:#888; font-size:9px;">${h.time}</div>${h.text.substring(0, 30)}...</div>`,
                ).join("");
            }
            function showToast(m) {
                const t = document.getElementById("toast");
                t.innerText = m;
                t.style.opacity = 1;
                setTimeout(() => (t.style.opacity = 0), 2000);
            }
            function focusHiddenInput() {
                if (!isEditMode && !isCorrectionMode) hInput.focus();
            }
            document.addEventListener("click", (e) => {
                if (isEditMode && outputArea.contains(e.target)) return;
                if (isCorrectionMode && correctionWrapper.contains(e.target))
                    return;
                if (e.target.id === "file-uploader") return; // 允许点击文件上传
                focusHiddenInput();
            });
            function makeResizableV(id, targetId) {
                const h = document.getElementById(id),
                    t = document.getElementById(targetId);
                h.addEventListener("mousedown", (e) => {
                    const startY = e.clientY,
                        startH = t.offsetHeight;
                    const drag = (ev) => {
                        const newH = startH + (ev.clientY - startY);
                        t.style.height = newH + "px";
                        settings.outputHeight = newH;
                    };
                    const stop = () => {
                        document.removeEventListener("mousemove", drag);
                        saveSettings();
                    };
                    document.addEventListener("mousemove", drag);
                    document.addEventListener("mouseup", stop);
                });
            }
            document.addEventListener("DOMContentLoaded", () => {
                makeResizableV("center-v-resizer", "output-card");
            });
            init();
            setInterval(focusHiddenInput, 1000);
        </script>
    </body>
</html>
