<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <title>Web IME Pro | 完整功能版</title>
        <style>
            :root {
                --primary: #007aff;
                --bg: #f2f2f7;
                --panel-bg: #ffffff;
                --text-main: #1d1d1f;
            }
            body {
                font-family:
                    system-ui,
                    -apple-system,
                    sans-serif;
                background: var(--bg);
                display: flex;
                justify-content: center;
                padding: 15px;
                min-height: 100vh;
                margin: 0;
                overflow: hidden;
            }
            .main-layout {
                display: flex;
                flex-direction: column;
                gap: 15px;
                width: 100%;
                max-width: 1500px;
                height: 96vh;
            }

            /* 顶部工具栏 */
            .toolbar {
                background: var(--panel-bg);
                padding: 12px 20px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                gap: 20px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            }
            .btn {
                padding: 8px 16px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                font-size: 13px;
                transition: 0.2s;
            }
            .btn-primary {
                background: #222;
                color: white;
            }
            .btn-secondary {
                background: #e5e5ea;
                color: #333;
            }

            /* 三栏布局 */
            .content-area {
                display: flex;
                gap: 15px;
                flex: 1;
                min-height: 0;
            }

            /* 左侧 35 格 */
            .side-panel {
                flex: 0 0 520px;
                background: var(--panel-bg);
                border-radius: 16px;
                display: flex;
                flex-direction: column;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                transition: 0.3s;
                border: 2px solid transparent;
            }
            .side-panel.active {
                border-color: var(--primary);
                background: #f0f7ff;
            }
            .panel-header {
                padding: 10px 15px;
                background: #f8f9fa;
                font-size: 11px;
                font-weight: bold;
                border-bottom: 1px solid #eee;
                border-radius: 16px 16px 0 0;
                display: flex;
                justify-content: space-between;
            }

            #side-grid {
                flex: 1;
                display: grid;
                grid-template-columns: repeat(5, 1fr);
                grid-template-rows: repeat(7, 1fr);
                gap: 6px;
                padding: 12px;
            }
            .grid-item {
                background: #fff;
                border: 1px solid #eee;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                font-size: 14px;
                position: relative;
                min-height: 50px;
            }
            .grid-key {
                font-family: monospace;
                font-size: 10px;
                color: #bbb;
                position: absolute;
                top: 4px;
                left: 6px;
            }

            /* 中间输入核心 */
            .center-container {
                flex: 1;
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            .input-card {
                background: white;
                padding: 25px;
                border-radius: 20px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
                flex: 1;
                display: flex;
                flex-direction: column;
            }

            #output-area {
                flex: 1;
                font-size: 28px;
                padding: 10px;
                line-height: 1.5;
                outline: none;
                word-break: break-all;
                white-space: pre-wrap;
                overflow-y: auto;
                color: var(--text-main);
            }
            /* 仿真光标 */
            .cursor {
                display: inline-block;
                width: 2.5px;
                height: 32px;
                background: var(--primary);
                margin-left: 2px;
                vertical-align: middle;
                animation: blink 1s infinite;
            }
            @keyframes blink {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0;
                }
            }

            #buffer-display {
                font-size: 18px;
                color: var(--primary);
                font-weight: bold;
                min-height: 28px;
                margin: 10px 0;
                display: flex;
                align-items: center;
                border-bottom: 2px solid #f0f0f0;
            }
            #main-candidates {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                min-height: 50px;
            }
            .main-item {
                padding: 10px 18px;
                background: #f9f9f9;
                border-radius: 10px;
                cursor: pointer;
                font-size: 20px;
                border: 1px solid #eee;
                transition: 0.1s;
            }
            .main-item:hover {
                background: #f0f0f0;
            }
            .main-item.is-en {
                border: 1px dashed var(--primary);
                color: var(--primary);
            }

            /* 右侧历史 */
            .history-panel {
                flex: 0 0 280px;
                background: #fff;
                border-radius: 16px;
                padding: 15px;
                display: flex;
                flex-direction: column;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            }
            .history-list {
                flex: 1;
                overflow-y: auto;
                margin-top: 10px;
            }
            .history-item {
                font-size: 13px;
                padding: 10px;
                border-bottom: 1px solid #f5f5f5;
                cursor: pointer;
                border-radius: 8px;
                margin-bottom: 5px;
            }
            .history-item:hover {
                background: #f9f9f9;
            }

            #hidden-input {
                position: absolute;
                opacity: 0;
                pointer-events: none;
            }
            #toast {
                position: fixed;
                top: 70px;
                left: 50%;
                transform: translateX(-50%);
                background: #333;
                color: white;
                padding: 8px 20px;
                border-radius: 20px;
                opacity: 0;
                transition: 0.3s;
                z-index: 999;
            }
        </style>
    </head>
    <body>
        <div class="main-layout">
            <div class="toolbar">
                <div class="tool-group">
                    <button class="btn btn-primary" onclick="archiveAndCopy()">
                        归档并复制 (Ctrl+C)
                    </button>
                    <button class="btn btn-secondary" onclick="refreshChaos()">
                        刷新灵感
                    </button>
                </div>
                <div
                    style="
                        flex: 1;
                        text-align: right;
                        font-size: 12px;
                        color: #888;
                    "
                >
                    <b>数字键选词已修复</b> | 无字母空格直出 | 蓝色仿真光标
                </div>
            </div>

            <div class="content-area">
                <div class="side-panel" id="side-panel">
                    <div class="panel-header">
                        <span>扩展候选 (Tab 键)</span
                        ><span id="side-status" style="opacity: 0.5"
                            >NORMAL</span
                        >
                    </div>
                    <div id="side-grid"></div>
                </div>

                <div
                    class="center-container"
                    onclick="document.getElementById('hidden-input').focus()"
                >
                    <div class="input-card">
                        <div id="output-area"></div>
                        <div id="buffer-display"></div>
                        <div id="main-candidates"></div>
                        <input
                            type="text"
                            id="hidden-input"
                            autocomplete="off"
                        />
                    </div>
                </div>

                <div class="history-panel">
                    <div
                        style="
                            font-size: 14px;
                            font-weight: bold;
                            display: flex;
                            justify-content: space-between;
                        "
                    >
                        存档记录
                        <a
                            href="#"
                            onclick="clearHistory()"
                            style="
                                font-size: 10px;
                                color: #ff3b30;
                                text-decoration: none;
                            "
                            >清空</a
                        >
                    </div>
                    <div class="history-list" id="history-list"></div>
                </div>
            </div>
        </div>

        <div id="toast">已同步</div>

        <script>
            let DICT = {},
                EN_DICT = {},
                CIZU_DICT = {},
                ALL_CHARS = [],
                CHAOS_POOL = [];
            let buffer = "",
                committed = "",
                isSideMode = false;
            let combinedCandidates = [];
            let HISTORY = JSON.parse(
                localStorage.getItem("ime_flow_v8") || "[]",
            );
            const SIDE_KEYS = "123456789abcdefghijklmnopqrstuvwxyz".split("");
            const SYMBOLS = {
                1: "，",
                2: "。",
                3: "？",
                4: "！",
                5: "“",
                6: "”",
                7: "：",
                8: "；",
                9: "…",
            };

            async function init() {
                try {
                    const [d1, d2, d3] = await Promise.all([
                        fetch("dict.json").then((r) => r.json()),
                        fetch("en_dict.json").then((r) => r.json()),
                        fetch("cizu_dict.json").then((r) => r.json()),
                    ]);
                    DICT = d1;
                    EN_DICT = d2;
                    CIZU_DICT = d3;
                    Object.values(DICT).forEach((list) =>
                        list.forEach((w) => {
                            if (w.length === 1) ALL_CHARS.push(w);
                        }),
                    );
                    refreshChaos();
                    updateHistoryUI();
                    update();
                } catch (e) {
                    console.error("Load fail");
                }
            }

            function refreshChaos() {
                CHAOS_POOL = [];
                for (let i = 0; i < 44; i++) {
                    let w =
                        ALL_CHARS[
                            Math.floor(Math.random() * ALL_CHARS.length)
                        ] +
                        ALL_CHARS[Math.floor(Math.random() * ALL_CHARS.length)];
                    CHAOS_POOL.push({ text: w, weight: 0, type: "chaos" });
                }
                update();
            }

            function update() {
                const area = document.getElementById("output-area");
                area.innerText = committed;
                const cursor = document.createElement("span");
                cursor.className = "cursor";
                area.appendChild(cursor);

                const bufDisp = document.getElementById("buffer-display");
                bufDisp.innerHTML = buffer
                    ? `<span>${buffer}</span>`
                    : `<span style="color:#ccc; font-weight:normal; font-size:14px;">准备就绪...</span>`;

                let list = [];
                if (buffer) {
                    const b = buffer.toLowerCase();
                    if (DICT[b])
                        DICT[b].forEach((v) =>
                            list.push({ text: v, weight: 1200, type: "zh" }),
                        );
                    if (CIZU_DICT[b])
                        CIZU_DICT[b].forEach((v) =>
                            list.push({ text: v, weight: 1100, type: "zh" }),
                        );
                    if (EN_DICT[b]) {
                        list.push({ text: b, weight: 850, type: "en" });
                        EN_DICT[b].forEach((zh) =>
                            list.push({ text: zh, weight: 800, type: "en-zh" }),
                        );
                    }
                    for (let word in EN_DICT) {
                        if (word.startsWith(b) && word !== b)
                            list.push({
                                text: word,
                                weight: 400 - word.length,
                                type: "en-pred",
                            });
                    }
                } else {
                    list = [...CHAOS_POOL];
                }

                const seen = new Set();
                combinedCandidates = list
                    .sort((a, b) => b.weight - a.weight)
                    .filter((x) => {
                        if (seen.has(x.text)) return false;
                        seen.add(x.text);
                        return true;
                    });
                render();
            }

            function render() {
                const mainItems = combinedCandidates.slice(0, 9);
                document.getElementById("main-candidates").innerHTML = mainItems
                    .map(
                        (item, i) => `
                    <div class="main-item ${item.type.startsWith("en") ? "is-en" : ""}" onclick="selectIdx(${i})">
                        <span style="font-size:11px; opacity:0.3; margin-right:5px;">${i + 1}</span>${item.text}
                    </div>
                `,
                    )
                    .join("");

                let gridHTML = "";
                const sideItems = combinedCandidates.slice(9, 44);
                for (let i = 0; i < 35; i++) {
                    gridHTML += `<div class="grid-item" onclick="selectIdx(${i + 9})"><span class="grid-key">${SIDE_KEYS[i].toUpperCase()}</span>${sideItems[i] ? sideItems[i].text : ""}</div>`;
                }
                document.getElementById("side-grid").innerHTML = gridHTML;
                document
                    .getElementById("side-panel")
                    .classList.toggle("active", isSideMode);
            }

            function selectIdx(idx) {
                const item = combinedCandidates[idx];
                if (item) {
                    committed += item.text;
                    buffer = "";
                    isSideMode = false;
                    update();
                    scrollOutput();
                }
            }

            function scrollOutput() {
                const area = document.getElementById("output-area");
                area.scrollTop = area.scrollHeight;
                document.getElementById("hidden-input").focus();
            }

            document
                .getElementById("hidden-input")
                .addEventListener("keydown", (e) => {
                    const key = e.key;

                    // 1. Shift 逻辑
                    if (e.shiftKey) {
                        if (SYMBOLS[key]) {
                            committed += SYMBOLS[key];
                            update();
                            e.preventDefault();
                            return;
                        }
                        if (key.length === 1) {
                            committed += key;
                            update();
                            e.preventDefault();
                            return;
                        }
                    }

                    // 2. Tab 逻辑
                    if (key === "Tab") {
                        isSideMode = !isSideMode;
                        render();
                        e.preventDefault();
                        return;
                    }

                    // 3. 有拼音 Buffer 时的选词逻辑 (含数字键修复)
                    if (buffer) {
                        // 数字键 1-9 选词
                        if (/^[1-9]$/.test(key) && !isSideMode) {
                            selectIdx(parseInt(key) - 1);
                            e.preventDefault();
                            return;
                        }
                        // 扩展区字母键选词
                        if (isSideMode) {
                            const idx = SIDE_KEYS.indexOf(key.toLowerCase());
                            if (idx !== -1) {
                                selectIdx(idx + 9);
                                e.preventDefault();
                                return;
                            }
                        }
                        // 退格
                        if (key === "Backspace") {
                            buffer = buffer.slice(0, -1);
                            update();
                            e.preventDefault();
                            return;
                        }
                        // 空格上屏首位
                        if (key === " ") {
                            selectIdx(0);
                            e.preventDefault();
                            return;
                        }
                        // 回车上屏拼音原文
                        if (key === "Enter") {
                            committed += buffer;
                            buffer = "";
                            update();
                            e.preventDefault();
                            return;
                        }
                    }

                    // 4. 无拼音时的逻辑
                    if (key === " ") {
                        committed += " ";
                        update();
                        e.preventDefault();
                        return;
                    }
                    if (key === "Backspace") {
                        committed = committed.slice(0, -1);
                        update();
                        e.preventDefault();
                        return;
                    }
                    if (key === "Enter") {
                        committed += "\n";
                        update();
                        e.preventDefault();
                        return;
                    }

                    // 5. 字母录入进入 Buffer
                    if (/^[a-z]$/i.test(key)) {
                        buffer += key.toLowerCase();
                        update();
                        e.preventDefault();
                    } else if (key.length === 1 && !buffer) {
                        // 其他单个字符（标点等）直接上屏
                        committed += key;
                        update();
                        e.preventDefault();
                    }

                    // Ctrl+C 快捷归档
                    if ((e.ctrlKey || e.metaKey) && key.toLowerCase() === "c") {
                        archiveAndCopy();
                        e.preventDefault();
                    }
                });

            async function archiveAndCopy() {
                if (!committed) return;
                await navigator.clipboard.writeText(committed);
                HISTORY.unshift({
                    text: committed,
                    time: new Date().toLocaleTimeString(),
                });
                committed = "";
                localStorage.setItem("ime_flow_v8", JSON.stringify(HISTORY));
                update();
                updateHistoryUI();
                showToast("归档成功");
            }

            function updateHistoryUI() {
                document.getElementById("history-list").innerHTML = HISTORY.map(
                    (h) =>
                        `<div class="history-item"><div>${h.text}</div></div>`,
                ).join("");
            }
            window.clearHistory = () => {
                HISTORY = [];
                localStorage.removeItem("ime_flow_v8");
                updateHistoryUI();
            };
            function showToast(msg) {
                const t = document.getElementById("toast");
                t.innerText = msg;
                t.style.opacity = 1;
                setTimeout(() => (t.style.opacity = 0), 1500);
            }

            init();
            window.onload = () =>
                document.getElementById("hidden-input").focus();
        </script>
    </body>
</html>
