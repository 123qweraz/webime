<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <title>Web IME Pro | 简洁版</title>
        <style>
            :root {
                --primary: #007aff;
                --bg: #f2f2f7;
                --panel-bg: #ffffff;
                --text-main: #1d1d1f;
            }
            body {
                font-family:
                    system-ui,
                    -apple-system,
                    sans-serif;
                background: var(--bg);
                display: flex;
                justify-content: center;
                padding: 15px;
                min-height: 100vh;
                margin: 0;
                overflow: hidden;
            }
            .main-layout {
                display: flex;
                flex-direction: column;
                gap: 15px;
                width: 100%;
                max-width: 1500px;
                height: 96vh;
            }
            .toolbar {
                background: var(--panel-bg);
                padding: 12px 20px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                gap: 20px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            }
            .btn {
                padding: 8px 16px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                font-size: 13px;
                transition: 0.2s;
            }
            .btn-primary {
                background: #222;
                color: white;
            }
            .btn-secondary {
                background: #e5e5ea;
                color: #333;
            }
            .btn-toggle {
                background: #e5e5ea;
                color: #333;
            }
            .btn-toggle.active {
                background: var(--primary);
                color: white;
            }

            .content-area {
                display: flex;
                gap: 15px;
                flex: 1;
                min-height: 0;
            }
            .side-panel {
                flex: 0 0 35%;
                min-width: 400px;
                background: var(--panel-bg);
                border-radius: 16px;
                display: flex;
                flex-direction: column;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                transition: 0.3s;
                border: 2px solid transparent;
            }
            .side-panel.active {
                border-color: var(--primary);
                background: #f0f7ff;
            }
            .panel-header {
                padding: 10px 15px;
                background: #f8f9fa;
                font-size: 11px;
                font-weight: bold;
                border-bottom: 1px solid #eee;
                border-radius: 16px 16px 0 0;
                display: flex;
                justify-content: space-between;
            }
            #side-grid {
                flex: 1;
                display: grid;
                grid-template-columns: repeat(5, 1fr);
                gap: 6px;
                padding: 12px;
                overflow-y: auto;
            }
            .grid-item {
                background: #fff;
                border: 1px solid #eee;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                font-size: 14px;
                position: relative;
                min-height: 50px;
            }
            .grid-item.empty {
                background: #f9f9f9;
                border-style: dashed;
                cursor: default;
                opacity: 0.6;
            }
            .grid-key {
                font-family: monospace;
                font-size: 10px;
                color: #bbb;
                position: absolute;
                top: 4px;
                left: 6px;
            }

            .center-container {
                flex: 1;
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            .input-card {
                background: white;
                padding: 25px;
                border-radius: 20px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
                flex: 1;
                display: flex;
                flex-direction: column;
            }
            #output-area {
                flex: 1;
                font-size: 28px;
                padding: 10px;
                line-height: 1.5;
                outline: none;
                word-break: break-all;
                white-space: pre-wrap;
                overflow-y: auto;
                color: var(--text-main);
            }
            .cursor {
                display: inline-block;
                width: 2.5px;
                height: 32px;
                background: var(--primary);
                margin-left: 2px;
                vertical-align: middle;
                animation: blink 1s infinite;
            }
            @keyframes blink {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0;
                }
            }

            #buffer-display {
                font-size: 18px;
                color: var(--primary);
                font-weight: bold;
                min-height: 28px;
                margin: 10px 0;
                display: flex;
                align-items: center;
                border-bottom: 2px solid #f0f0f0;
            }
            #main-candidates {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                min-height: 50px;
            }
            .main-item {
                padding: 10px 18px;
                background: #f9f9f9;
                border-radius: 10px;
                cursor: pointer;
                font-size: 20px;
                border: 1px solid #eee;
                transition: 0.1s;
            }
            .main-item:hover {
                background: #f0f0f0;
            }
            .main-item.is-pred {
                border: 1px dashed var(--primary);
                color: var(--primary);
            }

            .history-panel {
                flex: 0 0 280px;
                background: #fff;
                border-radius: 16px;
                padding: 15px;
                display: flex;
                flex-direction: column;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            }
            .history-list {
                flex: 1;
                overflow-y: auto;
                margin-top: 10px;
            }
            .history-item {
                font-size: 13px;
                padding: 10px;
                border-bottom: 1px solid #f5f5f5;
                cursor: pointer;
                border-radius: 8px;
                margin-bottom: 5px;
            }
            .history-item:hover {
                background: #f9f9f9;
            }

            #hidden-input {
                position: absolute;
                opacity: 0;
                pointer-events: none;
            }
            #toast {
                position: fixed;
                top: 70px;
                left: 50%;
                transform: translateX(-50%);
                background: #333;
                color: white;
                padding: 8px 20px;
                border-radius: 20px;
                opacity: 0;
                transition: 0.3s;
                z-index: 999;
            }
        </style>
    </head>
    <body>
        <div class="main-layout">
            <div class="toolbar">
                <div class="tool-group">
                    <button class="btn btn-primary" onclick="archiveAndCopy()">
                        归档并复制 (Ctrl+C)
                    </button>
                    <button
                        id="rare-toggle"
                        class="btn btn-toggle"
                        onclick="toggleRare()"
                    >
                        生僻词：关闭
                    </button>
                </div>
                <div
                    style="
                        flex: 1;
                        text-align: right;
                        font-size: 12px;
                        color: #888;
                    "
                >
                    <b>最好一个一个地输入 · 支持词组补全</b>
                </div>
            </div>

            <div class="content-area">
                <div class="side-panel" id="side-panel">
                    <div class="panel-header">
                        <span>扩展候选 (Tab 键切换)</span>
                        <span id="side-status" style="opacity: 0.5"
                            >NORMAL</span
                        >
                    </div>
                    <div id="side-grid"></div>
                </div>

                <div
                    class="center-container"
                    onclick="document.getElementById('hidden-input').focus()"
                >
                    <div class="input-card">
                        <div id="output-area"></div>
                        <div id="buffer-display"></div>
                        <div id="main-candidates"></div>
                        <input
                            type="text"
                            id="hidden-input"
                            autocomplete="off"
                        />
                    </div>
                </div>

                <div class="history-panel">
                    <div
                        style="
                            font-size: 14px;
                            font-weight: bold;
                            display: flex;
                            justify-content: space-between;
                        "
                    >
                        存档记录
                        <a
                            href="#"
                            onclick="clearHistory()"
                            style="
                                font-size: 10px;
                                color: #ff3b30;
                                text-decoration: none;
                            "
                            >清空</a
                        >
                    </div>
                    <div class="history-list" id="history-list"></div>
                </div>
            </div>
        </div>

        <div id="toast">已同步</div>

        <script>
            let DICT = {},
                LEVEL2 = null,
                LEVEL3 = null,
                EN_DICT = {},
                CIZU_DICT = {};
            let buffer = "",
                committed = "",
                isSideMode = false;
            let combinedCandidates = [];
            let HISTORY = JSON.parse(
                localStorage.getItem("ime_flow_v8") || "[]",
            );
            let rareEnabled = localStorage.getItem("rare_enabled") === "true";
            const SIDE_KEYS = "123456789abcdefghijklmnopqrstuvwxyz".split("");
            const SYMBOLS = {
                1: "，",
                2: "。",
                3: "？",
                4: "！",
                5: "“",
                6: "”",
                7: "：",
                8: "；",
                9: "…",
            };

            let currentSidePage = 0;
            const CANDIDATES_PER_PAGE = 35;

            async function init() {
                try {
                    const promises = [
                        fetch("dict.json").then((r) => r.json()),
                        fetch("en_dict.json").then((r) => r.json()),
                        fetch("cizu_dict.json").then((r) => r.json()),
                    ];
                    if (rareEnabled) {
                        promises.push(
                            fetch("level-2.json").then((r) => r.json()),
                        );
                        promises.push(
                            fetch("level-3.json").then((r) => r.json()),
                        );
                    } else {
                        promises.push(Promise.resolve(null));
                        promises.push(Promise.resolve(null));
                    }

                    const [d1, d2, d3, l2, l3] = await Promise.all(promises);
                    DICT = d1;
                    EN_DICT = d2;
                    CIZU_DICT = d3;
                    LEVEL2 = l2;
                    LEVEL3 = l3;

                    updateToggleButton();
                    updateHistoryUI();
                    update();
                } catch (e) {
                    console.error("词库加载失败", e);
                    showToast("部分词库加载失败");
                }
            }

            function updateToggleButton() {
                const btn = document.getElementById("rare-toggle");
                if (rareEnabled) {
                    btn.textContent = "生僻词：开启";
                    btn.classList.add("active");
                } else {
                    btn.textContent = "生僻词：关闭";
                    btn.classList.remove("active");
                }
            }

            window.toggleRare = async function () {
                rareEnabled = !rareEnabled;
                localStorage.setItem("rare_enabled", rareEnabled);
                showToast(rareEnabled ? "生僻词已开启" : "生僻词已关闭");
                currentSidePage = 0;
                await init();
            };

            function update() {
                const area = document.getElementById("output-area");
                area.innerHTML = committed;
                const cursor = document.createElement("span");
                cursor.className = "cursor";
                area.appendChild(cursor);

                const bufDisp = document.getElementById("buffer-display");
                bufDisp.innerHTML = buffer
                    ? `<span>${buffer}</span>`
                    : `<span style="color:#ccc; font-weight:normal; font-size:14px;">等待输入...</span>`;

                let list = [];
                if (buffer) {
                    const b = buffer.toLowerCase();

                    // 精确匹配：单字
                    if (DICT[b])
                        DICT[b].forEach((v) =>
                            list.push({ text: v, weight: 1300, type: "zh" }),
                        );

                    // 精确匹配：词组
                    if (CIZU_DICT[b])
                        CIZU_DICT[b].forEach((v) =>
                            list.push({
                                text: v,
                                weight: 1250,
                                type: "zh-cizu",
                            }),
                        );

                    // 生僻词
                    if (rareEnabled && LEVEL2 && LEVEL2[b])
                        LEVEL2[b].forEach((v) =>
                            list.push({ text: v, weight: 900, type: "zh-l2" }),
                        );
                    if (rareEnabled && LEVEL3 && LEVEL3[b])
                        LEVEL3[b].forEach((v) =>
                            list.push({ text: v, weight: 700, type: "zh-l3" }),
                        );

                    // 英文精确 + 翻译
                    if (EN_DICT[b]) {
                        list.push({ text: b, weight: 850, type: "en" });
                        EN_DICT[b].forEach((zh) =>
                            list.push({ text: zh, weight: 800, type: "en-zh" }),
                        );
                    }

                    // === 新增：词组前缀补全（模仿英文补全）===
                    for (let pinyin in CIZU_DICT) {
                        if (pinyin.startsWith(b) && pinyin !== b) {
                            CIZU_DICT[pinyin].forEach((hanzi) => {
                                list.push({
                                    text: hanzi,
                                    weight: 1100 - pinyin.length * 10, // 越长权重越低
                                    type: "cizu-pred",
                                });
                            });
                        }
                    }

                    // === 英文前缀补全（原有逻辑）===
                    for (let word in EN_DICT) {
                        if (word.startsWith(b) && word !== b)
                            list.push({
                                text: word,
                                weight: 400 - word.length,
                                type: "en-pred",
                            });
                    }
                }

                const seen = new Set();
                combinedCandidates = list
                    .sort((a, b) => b.weight - a.weight)
                    .filter((x) => {
                        if (seen.has(x.text)) return false;
                        seen.add(x.text);
                        return true;
                    });

                currentSidePage = 0;
                render();
            }

            function render() {
                // 主候选区（前10个）
                const mainItems = combinedCandidates.slice(0, 10);
                document.getElementById("main-candidates").innerHTML = mainItems
                    .map((item, i) => {
                        const keyDisplay = i === 9 ? "0" : i + 1;
                        const isPred = item.type.endsWith("-pred");
                        return `<div class="main-item ${isPred ? "is-pred" : ""}" onclick="selectIdx(${i})">
                            <span style="font-size:11px; opacity:0.3; margin-right:5px;">${keyDisplay}</span>${item.text}
                        </div>`;
                    })
                    .join("");

                // 扩展候选区
                const sideGrid = document.getElementById("side-grid");
                sideGrid.innerHTML = "";

                const sideItemsAll = combinedCandidates.slice(10);
                const totalPages = Math.ceil(
                    sideItemsAll.length / CANDIDATES_PER_PAGE,
                );
                currentSidePage = Math.max(
                    0,
                    Math.min(currentSidePage, totalPages - 1),
                );

                const start = currentSidePage * CANDIDATES_PER_PAGE;
                const sideItems = sideItemsAll.slice(
                    start,
                    start + CANDIDATES_PER_PAGE,
                );

                if (sideItemsAll.length > 0) {
                    document.getElementById("side-status").textContent =
                        `第 ${currentSidePage + 1}/${totalPages} 页 (-/= 翻页)`;
                } else {
                    document.getElementById("side-status").textContent =
                        "NORMAL";
                }

                if (buffer && sideItems.length > 0) {
                    sideItems.forEach((item, i) => {
                        const globalIdx = start + i + 10;
                        const keyLabel = SIDE_KEYS[i]
                            ? SIDE_KEYS[i].toUpperCase()
                            : "";
                        const div = document.createElement("div");
                        div.className = "grid-item";
                        const isPred = item.type.endsWith("-pred");
                        if (isPred)
                            div.style.border = `1px dashed ${getComputedStyle(document.documentElement).getPropertyValue("--primary")}`;
                        div.onclick = () => selectIdx(globalIdx);
                        div.innerHTML = `${keyLabel ? `<span class="grid-key">${keyLabel}</span>` : ""}${item.text}`;
                        sideGrid.appendChild(div);
                    });

                    const remainder = sideItems.length % 5;
                    if (remainder !== 0) {
                        for (let j = 0; j < 5 - remainder; j++) {
                            const empty = document.createElement("div");
                            empty.className = "grid-item empty";
                            sideGrid.appendChild(empty);
                        }
                    }
                } else if (buffer) {
                    sideGrid.innerHTML =
                        '<div style="grid-column: 1 / -1; text-align:center; color:#aaa; padding:20px;">无更多候选</div>';
                }

                document
                    .getElementById("side-panel")
                    .classList.toggle("active", isSideMode);
            }

            function selectIdx(idx) {
                const item = combinedCandidates[idx];
                if (item) {
                    committed += item.text;
                    buffer = "";
                    isSideMode = false;
                    currentSidePage = 0;
                    update();
                    scrollOutput();
                }
            }

            function scrollOutput() {
                const area = document.getElementById("output-area");
                area.scrollTop = area.scrollHeight;
                document.getElementById("hidden-input").focus();
            }

            document
                .getElementById("hidden-input")
                .addEventListener("keydown", (e) => {
                    const key = e.key;

                    if (e.shiftKey) {
                        if (SYMBOLS[key]) {
                            committed += SYMBOLS[key];
                            update();
                            e.preventDefault();
                            return;
                        }
                        if (key.length === 1) {
                            committed += key;
                            update();
                            e.preventDefault();
                            return;
                        }
                    }

                    if (key === "Tab") {
                        isSideMode = !isSideMode;
                        render();
                        e.preventDefault();
                        return;
                    }

                    if (isSideMode) {
                        if (key === "-") {
                            if (currentSidePage > 0) {
                                currentSidePage--;
                                render();
                            }
                            e.preventDefault();
                            return;
                        }
                        if (key === "=") {
                            const sideItemsAll = combinedCandidates.slice(10);
                            const totalPages = Math.ceil(
                                sideItemsAll.length / CANDIDATES_PER_PAGE,
                            );
                            if (currentSidePage < totalPages - 1) {
                                currentSidePage++;
                                render();
                            }
                            e.preventDefault();
                            return;
                        }
                    }

                    if (buffer) {
                        if (/^[0-9]$/.test(key)) {
                            let targetIdx = isSideMode
                                ? key === "0"
                                    ? 19
                                    : parseInt(key) + 9
                                : key === "0"
                                  ? 9
                                  : parseInt(key) - 1;
                            if (combinedCandidates[targetIdx]) {
                                selectIdx(targetIdx);
                                e.preventDefault();
                                return;
                            }
                        }

                        if (isSideMode) {
                            const sideIdx = SIDE_KEYS.indexOf(
                                key.toLowerCase(),
                            );
                            if (sideIdx !== -1) {
                                const globalIdx =
                                    currentSidePage * CANDIDATES_PER_PAGE +
                                    sideIdx +
                                    10;
                                if (combinedCandidates[globalIdx]) {
                                    selectIdx(globalIdx);
                                    e.preventDefault();
                                    return;
                                }
                            }
                        }

                        if (key === "Backspace") {
                            buffer = buffer.slice(0, -1);
                            update();
                            e.preventDefault();
                            return;
                        }
                        if (key === " ") {
                            selectIdx(0);
                            e.preventDefault();
                            return;
                        }
                        if (key === "Enter") {
                            committed += buffer;
                            buffer = "";
                            update();
                            e.preventDefault();
                            return;
                        }
                    }

                    if (key === " ") {
                        committed += " ";
                        update();
                        e.preventDefault();
                        return;
                    }
                    if (key === "Backspace" && !buffer) {
                        committed = committed.slice(0, -1);
                        update();
                        e.preventDefault();
                        return;
                    }
                    if (key === "Enter" && !buffer) {
                        committed += "\n";
                        update();
                        e.preventDefault();
                        return;
                    }
                    if (/^[a-z]$/i.test(key)) {
                        buffer += key.toLowerCase();
                        update();
                        e.preventDefault();
                    } else if (key.length === 1 && !buffer) {
                        committed += key;
                        update();
                        e.preventDefault();
                    }

                    if ((e.ctrlKey || e.metaKey) && key.toLowerCase() === "c") {
                        archiveAndCopy();
                        e.preventDefault();
                    }
                });

            async function archiveAndCopy() {
                if (!committed) return;
                await navigator.clipboard.writeText(committed);
                HISTORY.unshift({
                    text: committed,
                    time: new Date().toLocaleTimeString(),
                });
                committed = "";
                localStorage.setItem("ime_flow_v8", JSON.stringify(HISTORY));
                update();
                updateHistoryUI();
                showToast("归档成功");
            }

            function updateHistoryUI() {
                document.getElementById("history-list").innerHTML = HISTORY.map(
                    (h) =>
                        `<div class="history-item"><div>${h.text}</div></div>`,
                ).join("");
            }

            window.clearHistory = () => {
                HISTORY = [];
                localStorage.removeItem("ime_flow_v8");
                updateHistoryUI();
            };

            function showToast(msg) {
                const t = document.getElementById("toast");
                t.innerText = msg;
                t.style.opacity = 1;
                setTimeout(() => (t.style.opacity = 0), 1500);
            }

            init();
            window.onload = () =>
                document.getElementById("hidden-input").focus();
        </script>
    </body>
</html>
