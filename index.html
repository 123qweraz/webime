<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Web IME Pro | 联想增强版</title>
        <style>
            :root {
                --primary: #007aff;
                --bg: #f2f2f7;
                --panel-bg: #ffffff;
                --text-main: #1d1d1f;
                --item-bg: #f9f9f9;
                --item-border: #eee;
                --baidu-color: #de0f17;
                --google-color: #4285f4;
            }
            body {
                font-family:
                    system-ui,
                    -apple-system,
                    sans-serif;
                background: var(--bg);
                margin: 0;
                padding: 15px;
                min-height: 100vh;
                display: flex;
                justify-content: center;
                overflow: hidden;
            }
            .main-layout {
                display: flex;
                flex-direction: column;
                gap: 15px;
                width: 100%;
                max-width: 1900px;
                height: 96vh;
            }
            .toolbar {
                background: var(--panel-bg);
                padding: 12px 20px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                gap: 12px;
                flex-wrap: wrap;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            }
            .btn {
                padding: 8px 16px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                font-size: 13px;
                transition: 0.2s;
                user-select: none;
            }
            .btn-primary {
                background: #222;
                color: white;
            }
            .btn-toggle {
                background: #e5e5ea;
                color: #333;
            }
            .btn-toggle.active {
                background: var(--primary);
                color: white;
            }
            .btn-send {
                background: #5856d6;
                color: white;
            }
            .btn-search {
                color: white;
                min-width: 110px;
                transition: 0.3s;
            }
            .btn-search.baidu {
                background: var(--baidu-color);
            }
            .btn-search.google {
                background: var(--google-color);
            }

            .content-area {
                flex: 1;
                display: flex;
                gap: 15px;
                min-height: 0;
                position: relative;
                justify-content: center; /* 确保中间内容在两侧面板关掉时居中 */
            }

            /* 历史记录面板 */
            .history-panel {
                flex: 0 0 280px;
                background: #fff;
                border-radius: 16px;
                padding: 15px;
                display: flex;
                flex-direction: column;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            }
            .history-list {
                flex: 1;
                overflow-y: auto;
                margin-top: 10px;
            }
            .history-item {
                position: relative;
                padding: 10px;
                border-bottom: 1px solid #f5f5f5;
                cursor: pointer;
                border-radius: 8px;
                margin-bottom: 5px;
            }
            .history-text {
                word-break: break-all;
                font-size: 14px;
                line-height: 1.4;
            }
            .copy-hint {
                float: right;
                font-size: 10px;
                color: var(--primary);
                opacity: 0;
            }
            .history-item:hover .copy-hint {
                opacity: 0.6;
            }

            .history-footer {
                margin-top: 10px;
                padding-top: 10px;
                border-top: 1px solid #eee;
                display: flex;
                gap: 5px;
            }
            .btn-small {
                padding: 5px;
                font-size: 11px;
                flex: 1;
            }

            /* 中间主容器：优化后的宽度控制 */
            .center-container {
                flex: 1;
                display: flex;
                flex-direction: column;
                gap: 15px;
                min-width: 300px;
                max-width: 900px; /* 限制最大宽度，防止满屏过宽 */
                margin: 0 auto; /* 居中平衡 */
            }

            .output-card {
                position: relative;
                background: white;
                padding: 25px;
                border-radius: 20px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
                height: 150px;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                border: 2px solid transparent;
            }
            .output-card.is-focused {
                border-color: rgba(0, 122, 255, 0.1);
            }
            #output-area {
                flex: 1;
                font-size: 26px;
                line-height: 1.5;
                word-break: break-all;
                white-space: pre-wrap;
                overflow-y: auto;
                color: var(--text-main);
            }

            .cursor {
                display: none;
                width: 2.5px;
                height: 30px;
                background: var(--primary);
                margin-left: 2px;
                vertical-align: middle;
            }
            .output-card.is-focused .cursor {
                display: inline-block;
                animation: blink 1s infinite;
            }
            @keyframes blink {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0;
                }
            }

            .action-btns {
                position: absolute;
                right: 20px;
                bottom: 15px;
                z-index: 10;
                display: flex;
                gap: 8px;
            }

            .input-card {
                background: white;
                padding: 20px; /* 增加一点内边距更透气 */
                border-radius: 20px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
                flex: 1;
                min-height: 0;
                display: flex;
                flex-direction: column;
            }
            #buffer-display {
                font-size: 18px;
                color: var(--primary);
                font-weight: bold;
                min-height: 28px;
                margin-bottom: 10px;
                border-bottom: 2px solid #f0f0f0;
            }
            #main-candidates {
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
                margin-bottom: 10px;
            }

            .candidate-item {
                position: relative;
                padding: 12px 12px 6px 12px;
                background: var(--item-bg);
                border-radius: 10px;
                cursor: pointer;
                font-size: 18px;
                border: 1px solid var(--item-border);
                transition: 0.1s;
                min-width: 30px;
                text-align: center;
            }
            .candidate-item:hover {
                background: #f0f0f0;
                transform: translateY(-1px);
            }
            .candidate-item.is-pred {
                border: 1px dashed var(--primary);
                color: var(--primary);
            }

            .cand-key {
                position: absolute;
                top: 2px;
                left: 5px;
                font-size: 10px;
                opacity: 0.4;
                font-family: Monaco, monospace;
            }

            #extended-section {
                display: none;
                flex-direction: column;
                flex: 1;
                min-height: 0;
                border-top: 1px solid #eee;
                padding-top: 15px;
            }
            #extended-section.visible {
                display: flex;
            }
            #extended-section.active {
                border: 2px solid var(--primary);
                border-radius: 16px;
                padding: 10px;
                margin-top: 5px;
                background: #fafcff;
            }
            #side-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
                gap: 5px;
                overflow-y: auto;
            }

            /* 长文面板 */
            .long-text-panel {
                flex: 0 0 300px;
                background: white;
                border-radius: 20px;
                display: flex;
                flex-direction: column;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
                overflow: hidden;
            }
            .long-text-panel.hidden {
                display: none;
            }
            .long-text-header {
                padding: 12px 15px;
                background: #f8f9fa;
                border-bottom: 1px solid #eee;
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 14px;
                font-weight: bold;
            }
            #long-text-editor {
                flex: 1;
                padding: 18px;
                font-size: 17px;
                line-height: 1.7;
                border: none;
                outline: none;
                resize: none;
                background: #fafafa;
                pointer-events: none;
                user-select: none;
            }
            #long-text-editor.editable {
                pointer-events: auto;
                user-select: text;
                background: white;
            }

            #hidden-input {
                position: absolute;
                opacity: 0;
                pointer-events: none;
            }
            #toast {
                position: fixed;
                top: 70px;
                left: 50%;
                transform: translateX(-50%);
                background: #333;
                color: white;
                padding: 10px 24px;
                border-radius: 20px;
                opacity: 0;
                transition: 0.3s;
                z-index: 999;
            }
        </style>
    </head>
    <body>
        <div class="main-layout">
            <div class="toolbar">
                <div class="tool-group">
                    <button
                        id="rare-toggle"
                        class="btn btn-toggle"
                        onclick="toggleRare()"
                    >
                        生僻词
                    </button>
                    <button
                        id="english-toggle"
                        class="btn btn-toggle"
                        onclick="toggleEnglish()"
                    >
                        英文支持
                    </button>
                    <button
                        id="cizu-toggle"
                        class="btn btn-toggle"
                        onclick="toggleCizu()"
                    >
                        词组补全
                    </button>
                    <button
                        id="toggle-side"
                        class="btn btn-toggle"
                        onclick="toggleSidePanel()"
                    >
                        扩展区
                    </button>
                    <button
                        id="toggle-history"
                        class="btn btn-toggle"
                        onclick="toggleHistoryPanel()"
                    >
                        存档记录
                    </button>
                    <button
                        id="toggle-longtext"
                        class="btn btn-toggle"
                        onclick="toggleLongTextPanel()"
                    >
                        长文编辑
                    </button>
                </div>
                <div
                    style="
                        flex: 1;
                        text-align: right;
                        font-size: 12px;
                        color: #888;
                    "
                >
                    Ctrl+Enter 发送长文 | Ctrl+C 归档
                </div>
            </div>

            <div class="content-area">
                <div class="history-panel" id="history-panel">
                    <div
                        style="
                            font-size: 14px;
                            font-weight: bold;
                            display: flex;
                            justify-content: space-between;
                        "
                    >
                        存档记录
                        <a
                            href="#"
                            onclick="clearHistory()"
                            style="
                                font-size: 10px;
                                color: red;
                                text-decoration: none;
                            "
                            >清空</a
                        >
                    </div>
                    <div class="history-list" id="history-list"></div>

                    <div class="history-footer">
                        <button
                            class="btn btn-toggle btn-small"
                            onclick="exportHistory()"
                        >
                            导出记录
                        </button>
                        <button
                            class="btn btn-toggle btn-small"
                            onclick="
                                document.getElementById('import-input').click()
                            "
                        >
                            导入记录
                        </button>
                        <input
                            type="file"
                            id="import-input"
                            accept=".json"
                            style="display: none"
                            onchange="importHistory(event)"
                        />
                    </div>
                </div>

                <div class="center-container" onclick="focusHiddenInput()">
                    <div class="output-card" id="output-card">
                        <div id="output-area"></div>
                        <div class="action-btns">
                            <button
                                id="search-btn"
                                class="btn btn-search baidu"
                            >
                                百度 (长按切换)
                            </button>
                            <button
                                class="btn btn-send"
                                onclick="sendToLongText()"
                            >
                                发送长文 (Ctrl+Enter)
                            </button>
                            <button
                                class="btn btn-primary"
                                onclick="archiveAndCopy()"
                            >
                                归档 (Ctrl+C)
                            </button>
                        </div>
                    </div>

                    <div class="input-card">
                        <div id="buffer-display"></div>
                        <div id="main-candidates"></div>
                        <div id="extended-section">
                            <div
                                style="
                                    padding: 0 0 10px 5px;
                                    font-size: 12px;
                                    opacity: 0.6;
                                "
                            >
                                扩展候选 (Tab 键翻页)
                                <span id="side-status"></span>
                            </div>
                            <div id="side-grid"></div>
                        </div>
                        <input
                            type="text"
                            id="hidden-input"
                            autocomplete="off"
                        />
                    </div>
                </div>

                <div class="long-text-panel" id="long-text-panel">
                    <div class="long-text-header">
                        <span>长文编辑区</span>
                        <button
                            id="edit-mode-btn"
                            class="btn btn-toggle"
                            style="padding: 4px 8px; font-size: 11px"
                            onclick="toggleLongTextEdit()"
                        >
                            编辑/锁定
                        </button>
                    </div>
                    <textarea
                        id="long-text-editor"
                        placeholder="在此累积句子..."
                    ></textarea>
                    <div
                        style="
                            padding: 10px;
                            border-top: 1px solid #eee;
                            display: flex;
                            gap: 5px;
                        "
                    >
                        <button
                            class="btn"
                            style="flex: 1; font-size: 11px"
                            onclick="copyLongText()"
                        >
                            全选复制
                        </button>
                        <button
                            class="btn"
                            style="flex: 1; font-size: 11px; color: red"
                            onclick="
                                if (confirm('清空？'))
                                    document.getElementById(
                                        'long-text-editor',
                                    ).value = '';
                            "
                        >
                            清空
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="toast">已就绪</div>

        <script>
            let DICT = {},
                LEVEL2 = null,
                LEVEL3 = null,
                EN_DICT = {},
                CIZU_DICT = {};
            let buffer = "",
                committed = "",
                isSideMode = false,
                currentSidePage = 0;
            let combinedCandidates = [],
                HISTORY = JSON.parse(
                    localStorage.getItem("ime_flow_v9") || "[]",
                );

            let rareEnabled = localStorage.getItem("rare_enabled") === "true";
            let englishEnabled =
                localStorage.getItem("english_enabled") === "true";
            let cizuEnabled = localStorage.getItem("cizu_enabled") === "true";

            let sideVisible = localStorage.getItem("side_visible") !== "false";
            let historyVisible =
                localStorage.getItem("history_visible") !== "false";
            let longTextVisible =
                localStorage.getItem("longtext_visible") !== "false";
            let isLongTextEditable = false;

            let currentSearchEngine =
                localStorage.getItem("search_engine") || "baidu";
            let searchTimer,
                isLongPress = false;

            const SIDE_KEYS = "123456789abcdefghijklmnopqrstuvwxyz".split("");
            const CANDIDATES_PER_PAGE = 35;

            const hInput = document.getElementById("hidden-input");
            const oCard = document.getElementById("output-card");
            hInput.addEventListener("focus", () =>
                oCard.classList.add("is-focused"),
            );
            hInput.addEventListener("blur", () =>
                oCard.classList.remove("is-focused"),
            );

            const searchBtn = document.getElementById("search-btn");
            function updateSearchBtnUI() {
                searchBtn.innerText =
                    currentSearchEngine === "google"
                        ? "Google (长按切换)"
                        : "百度 (长按切换)";
                searchBtn.className = `btn btn-search ${currentSearchEngine}`;
            }
            updateSearchBtnUI();

            searchBtn.addEventListener("mousedown", () => {
                isLongPress = false;
                searchTimer = setTimeout(() => {
                    currentSearchEngine =
                        currentSearchEngine === "baidu" ? "google" : "baidu";
                    localStorage.setItem("search_engine", currentSearchEngine);
                    updateSearchBtnUI();
                    showToast(
                        `已切换至 ${currentSearchEngine === "baidu" ? "百度" : "Google"}`,
                    );
                    isLongPress = true;
                }, 600);
            });
            searchBtn.addEventListener("mouseup", () => {
                clearTimeout(searchTimer);
                if (!isLongPress) executeSearch();
            });

            function executeSearch() {
                if (!committed) {
                    showToast("内容为空");
                    return;
                }
                const url =
                    currentSearchEngine === "baidu"
                        ? `https://www.baidu.com/s?wd=${encodeURIComponent(committed)}`
                        : `https://www.google.com/search?q=${encodeURIComponent(committed)}`;
                window.open(url);
                archiveToHistory(committed);
                committed = "";
                update();
            }

            async function init() {
                try {
                    const promises = [fetch("dict.json").then((r) => r.json())];
                    promises.push(
                        englishEnabled
                            ? fetch("en_dict.json").then((r) => r.json())
                            : Promise.resolve({}),
                    );
                    promises.push(
                        cizuEnabled
                            ? fetch("cizu_dict.json").then((r) => r.json())
                            : Promise.resolve({}),
                    );
                    if (rareEnabled) {
                        promises.push(
                            fetch("level-2.json").then((r) => r.json()),
                            fetch("level-3.json").then((r) => r.json()),
                        );
                    } else {
                        promises.push(
                            Promise.resolve(null),
                            Promise.resolve(null),
                        );
                    }
                    const [d1, en, cz, l2, l3] = await Promise.all(promises);
                    DICT = d1;
                    EN_DICT = en;
                    CIZU_DICT = cz;
                    LEVEL2 = l2;
                    LEVEL3 = l3;

                    document.getElementById("history-panel").style.display =
                        historyVisible ? "flex" : "none";
                    document
                        .getElementById("long-text-panel")
                        .classList.toggle("hidden", !longTextVisible);

                    updateAllToggleButtons();
                    updateHistoryUI();
                    update();
                } catch (e) {
                    showToast("词库加载失败");
                }
            }

            function update() {
                const area = document.getElementById("output-area");
                area.innerHTML = committed || "";
                const cursor = document.createElement("span");
                cursor.className = "cursor";
                area.appendChild(cursor);
                document.getElementById("buffer-display").innerText = buffer;

                let list = [];
                if (buffer) {
                    const b = buffer.toLowerCase();
                    if (DICT[b])
                        DICT[b].forEach((v) =>
                            list.push({ text: v, weight: 1300, type: "zh" }),
                        );
                    if (cizuEnabled && CIZU_DICT[b])
                        CIZU_DICT[b].forEach((v) =>
                            list.push({ text: v, weight: 1250, type: "zh-cz" }),
                        );
                    if (rareEnabled && LEVEL2 && LEVEL2[b])
                        LEVEL2[b].forEach((v) =>
                            list.push({ text: v, weight: 900, type: "zh-l2" }),
                        );
                    if (rareEnabled && LEVEL3 && LEVEL3[b])
                        LEVEL3[b].forEach((v) =>
                            list.push({ text: v, weight: 700, type: "zh-l3" }),
                        );
                    if (englishEnabled && EN_DICT[b]) {
                        list.push({ text: b, weight: 850, type: "en" });
                        EN_DICT[b].forEach((zh) =>
                            list.push({ text: zh, weight: 800, type: "en-zh" }),
                        );
                    }
                    if (cizuEnabled) {
                        for (let p in CIZU_DICT) {
                            if (p.startsWith(b) && p !== b) {
                                CIZU_DICT[p].forEach((h) =>
                                    list.push({
                                        text: h,
                                        weight: 1100 - p.length * 10,
                                        type: "cz-pred",
                                    }),
                                );
                            }
                        }
                    }
                }
                const seen = new Set();
                combinedCandidates = list
                    .sort((a, b) => b.weight - a.weight)
                    .filter((x) => !seen.has(x.text) && seen.add(x.text));
                render();
                area.scrollTop = area.scrollHeight;
            }

            function render() {
                document.getElementById("main-candidates").innerHTML =
                    combinedCandidates
                        .slice(0, 10)
                        .map(
                            (item, i) => `
                    <div class="candidate-item ${item.type && item.type.endsWith("-pred") ? "is-pred" : ""}" onclick="selectIdx(${i})">
                        <span class="cand-key">${i === 9 ? 0 : i + 1}</span>
                        <div class="cand-text">${item.text}</div>
                    </div>
                `,
                        )
                        .join("");

                const sideAll = combinedCandidates.slice(10);
                const totalP = Math.ceil(sideAll.length / CANDIDATES_PER_PAGE);
                const start = currentSidePage * CANDIDATES_PER_PAGE;
                const sideItems = sideAll.slice(
                    start,
                    start + CANDIDATES_PER_PAGE,
                );

                document.getElementById("side-status").innerText =
                    sideAll.length ? `(${currentSidePage + 1}/${totalP})` : "";
                const grid = document.getElementById("side-grid");
                grid.innerHTML = sideItems
                    .map(
                        (item, i) => `
                    <div class="candidate-item ${item.type && item.type.endsWith("-pred") ? "is-pred" : ""}" onclick="selectIdx(${start + i + 10})">
                        <span class="cand-key">${SIDE_KEYS[i].toUpperCase()}</span>
                        <div class="cand-text">${item.text}</div>
                    </div>
                `,
                    )
                    .join("");

                document
                    .getElementById("extended-section")
                    .classList.toggle(
                        "visible",
                        sideVisible && combinedCandidates.length > 10,
                    );
                document
                    .getElementById("extended-section")
                    .classList.toggle("active", isSideMode);
            }

            function selectIdx(idx) {
                if (combinedCandidates[idx]) {
                    committed += combinedCandidates[idx].text;
                    buffer = "";
                    isSideMode = false;
                    currentSidePage = 0;
                    update();
                }
            }

            window.toggleLongTextPanel = () => {
                longTextVisible = !longTextVisible;
                localStorage.setItem("longtext_visible", longTextVisible);
                document
                    .getElementById("long-text-panel")
                    .classList.toggle("hidden", !longTextVisible);
                document
                    .getElementById("toggle-longtext")
                    .classList.toggle("active", longTextVisible);
            };

            window.toggleLongTextEdit = () => {
                isLongTextEditable = !isLongTextEditable;
                const editor = document.getElementById("long-text-editor");
                editor.classList.toggle("editable", isLongTextEditable);
                document
                    .getElementById("edit-mode-btn")
                    .classList.toggle("active", isLongTextEditable);
                if (isLongTextEditable) editor.focus();
                else focusHiddenInput();
            };

            window.copyLongText = () => {
                const editor = document.getElementById("long-text-editor");
                editor.select();
                document.execCommand("copy");
                showToast("全选复制成功");
            };

            window.sendToLongText = () => {
                if (!committed) return;
                const editor = document.getElementById("long-text-editor");
                editor.value += (editor.value ? "\n" : "") + committed;
                committed = "";
                update();
                showToast("已发送到长文");
            };

            hInput.addEventListener("keydown", (e) => {
                const key = e.key;
                if ((e.ctrlKey || e.metaKey) && key === "Enter") {
                    e.preventDefault();
                    sendToLongText();
                    return;
                }
                if ((e.ctrlKey || e.metaKey) && key.toLowerCase() === "c") {
                    e.preventDefault();
                    archiveAndCopy();
                    return;
                }
                if (key === "Tab") {
                    e.preventDefault();
                    isSideMode = !isSideMode;
                    render();
                    return;
                }

                if (isSideMode) {
                    if (key === "=") {
                        currentSidePage++;
                        render();
                        e.preventDefault();
                        return;
                    }
                    if (key === "-" && currentSidePage > 0) {
                        currentSidePage--;
                        render();
                        e.preventDefault();
                        return;
                    }
                    const sIdx = SIDE_KEYS.indexOf(key.toLowerCase());
                    if (sIdx !== -1) {
                        const gIdx =
                            currentSidePage * CANDIDATES_PER_PAGE + sIdx + 10;
                        if (combinedCandidates[gIdx]) {
                            selectIdx(gIdx);
                            e.preventDefault();
                            return;
                        }
                    }
                }
                if (buffer && /^[0-9]$/.test(key)) {
                    e.preventDefault();
                    const n = key === "0" ? 9 : parseInt(key) - 1;
                    selectIdx(n);
                    return;
                }
                if (key === "Backspace") {
                    if (buffer) buffer = buffer.slice(0, -1);
                    else committed = committed.slice(0, -1);
                    update();
                    e.preventDefault();
                    return;
                }
                if (key === " ") {
                    e.preventDefault();
                    if (buffer) selectIdx(0);
                    else committed += " ";
                    update();
                    return;
                }
                if (key === "Enter") {
                    e.preventDefault();
                    if (buffer) {
                        committed += buffer;
                        buffer = "";
                    } else committed += "\n";
                    update();
                    return;
                }
                if (/^[a-z]$/.test(key)) {
                    e.preventDefault();
                    buffer += key;
                    update();
                    return;
                }
                if (key.length === 1 && !buffer && !e.ctrlKey) {
                    e.preventDefault();
                    committed += key;
                    update();
                    return;
                }
            });

            function archiveToHistory(text) {
                if (!text) return;
                HISTORY.unshift({
                    text: text,
                    time: new Date().toLocaleTimeString(),
                });
                if (HISTORY.length > 100) HISTORY = HISTORY.slice(0, 100);
                localStorage.setItem("ime_flow_v9", JSON.stringify(HISTORY));
                updateHistoryUI();
            }

            async function archiveAndCopy() {
                if (!committed) return;
                await navigator.clipboard.writeText(committed);
                archiveToHistory(committed);
                committed = "";
                update();
                showToast("已归档并复制");
            }

            function updateHistoryUI() {
                document.getElementById("history-list").innerHTML = HISTORY.map(
                    (h, i) => `
                    <div class="history-item" onclick="copyHistory(${i})" ondblclick="restoreHistory(${i})">
                        <div class="history-text">${h.text}</div>
                        <span class="copy-hint">点击复制/双击恢复</span>
                    </div>
                `,
                ).join("");
            }

            window.copyHistory = (i) =>
                navigator.clipboard
                    .writeText(HISTORY[i].text)
                    .then(() => showToast("已复制"));
            window.restoreHistory = (i) => {
                committed = HISTORY[i].text;
                update();
                showToast("已恢复");
            };
            window.clearHistory = () => {
                if (confirm("清空？")) {
                    HISTORY = [];
                    updateHistoryUI();
                }
            };

            window.exportHistory = () => {
                const a = Object.assign(document.createElement("a"), {
                    href: URL.createObjectURL(
                        new Blob([JSON.stringify(HISTORY)], {
                            type: "application/json",
                        }),
                    ),
                    download: `history.json`,
                });
                a.click();
                showToast("导出成功");
            };
            window.importHistory = async (e) => {
                try {
                    const text = await e.target.files[0].text();
                    HISTORY = [...JSON.parse(text), ...HISTORY].slice(0, 100);
                    localStorage.setItem(
                        "ime_flow_v9",
                        JSON.stringify(HISTORY),
                    );
                    updateHistoryUI();
                    showToast("导入成功");
                } catch (err) {
                    showToast("导入失败");
                }
            };

            function updateAllToggleButtons() {
                const items = {
                    "rare-toggle": [rareEnabled, "生僻词"],
                    "english-toggle": [englishEnabled, "英文"],
                    "cizu-toggle": [cizuEnabled, "词组"],
                    "toggle-side": [sideVisible, "扩展区"],
                    "toggle-history": [historyVisible, "存档记录"],
                    "toggle-longtext": [longTextVisible, "长文编辑"],
                };
                for (let id in items) {
                    const b = document.getElementById(id);
                    if (b) {
                        b.textContent = `${items[id][1]}：${items[id][0] ? "开" : "关"}`;
                        b.classList.toggle("active", items[id][0]);
                    }
                }
            }

            function showToast(m) {
                const t = document.getElementById("toast");
                t.innerText = m;
                t.style.opacity = 1;
                setTimeout(() => (t.style.opacity = 0), 2000);
            }
            function focusHiddenInput() {
                if (!isLongTextEditable)
                    document.getElementById("hidden-input").focus();
            }

            window.toggleRare = async () => {
                rareEnabled = !rareEnabled;
                localStorage.setItem("rare_enabled", rareEnabled);
                await init();
            };
            window.toggleEnglish = async () => {
                englishEnabled = !englishEnabled;
                localStorage.setItem("english_enabled", englishEnabled);
                await init();
            };
            window.toggleCizu = async () => {
                cizuEnabled = !cizuEnabled;
                localStorage.setItem("cizu_enabled", cizuEnabled);
                await init();
            };

            window.toggleSidePanel = () => {
                sideVisible = !sideVisible;
                localStorage.setItem("side_visible", sideVisible);
                updateAllToggleButtons();
                render();
            };

            window.toggleHistoryPanel = () => {
                historyVisible = !historyVisible;
                localStorage.setItem("history_visible", historyVisible);
                document.getElementById("history-panel").style.display =
                    historyVisible ? "flex" : "none";
                updateAllToggleButtons();
            };

            init();
            window.onload = focusHiddenInput;
        </script>
    </body>
</html>
