<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>汉字浏览器</title>
        <style>
            :root {
                --primary: #007aff;
                --primary-light: rgba(0, 122, 255, 0.1);
                --success: #34c759;
                --danger: #ff3b30;
                --bg: #f5f5f7;
                --card-bg: #ffffff;
                --text-main: #1d1d1f;
                --text-sec: #86868b;
                --border: rgba(0, 0, 0, 0.08);
                --shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
                --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
                --radius-lg: 18px;
                --radius-md: 12px;
            }
            body {
                font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Helvetica Neue", Arial, sans-serif;
                background-color: var(--bg);
                color: var(--text-main);
                margin: 0;
                padding: 20px;
                display: flex;
                justify-content: center;
                align-items: flex-start;
                min-height: 100vh;
                box-sizing: border-box;
                -webkit-font-smoothing: antialiased;
            }
            #main-container {
                width: 100%;
                max-width: 1400px;
                height: calc(100vh - 40px);
                background-color: var(--card-bg);
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow);
                display: flex;
                flex-direction: column;
                overflow: hidden;
                border: 1px solid var(--border);
            }
            .toolbar {
                padding: 16px 24px;
                background: var(--card-bg);
                border-bottom: 1px solid var(--border);
                display: flex;
                align-items: center;
                gap: 16px;
            }
            #dict-selector,
            #sort-selector,
            #search-input {
                font-size: 14px;
                padding: 10px 16px;
                border-radius: var(--radius-md);
                border: 1px solid var(--border);
                background-color: var(--bg);
                color: var(--text-main);
                transition: all 0.2s;
                outline: none;
            }
            #search-input { width: 300px; }
            #search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-light); }
            
            #content-area {
                padding: 24px;
                overflow-y: auto;
                flex-grow: 1;
            }
            #combination-section {
                position: relative;
                margin-bottom: 32px;
            }
            #combination-area {
                padding: 24px;
                border: 2px dashed var(--border);
                border-radius: var(--radius-lg);
                min-height: 80px;
                display: flex;
                align-items: center;
                gap: 12px;
                background-color: var(--bg);
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            #combination-area.valid { background-color: rgba(52, 199, 89, 0.1); border-color: var(--success); }
            #combination-area.invalid { background-color: rgba(255, 59, 48, 0.1); border-color: var(--danger); }
            
            .entry-char-wrapper { position: relative; transition: transform 0.2s ease; }
            .entry-char-wrapper.selected .entry-char { border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-light); }
            
            .entry-char {
                font-size: 32px;
                padding: 8px 16px;
                background: var(--card-bg);
                color: var(--text-main);
                border-radius: var(--radius-md);
                border: 1px solid var(--border);
                cursor: pointer;
                box-shadow: var(--shadow-sm);
            }
            
            .char-toolbar {
                position: absolute;
                bottom: -45px;
                left: 50%;
                transform: translateX(-50%);
                display: flex;
                gap: 6px;
                background: #1d1d1f;
                padding: 6px;
                border-radius: 10px;
                z-index: 100;
                box-shadow: var(--shadow);
            }
            .char-toolbar button {
                background: rgba(255, 255, 255, 0.1);
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                width: 30px;
                height: 30px;
                font-size: 14px;
                transition: all 0.2s;
            }
            .char-toolbar button:hover { background: rgba(255, 255, 255, 0.2); }
            
            #entry-list {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 20px;
            }
            .entry-card {
                aspect-ratio: 1 / 1;
                background-color: var(--bg);
                border-radius: var(--radius-lg);
                border: 1px solid var(--border);
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                cursor: pointer;
                position: relative;
                overflow: hidden;
            }
            .entry-card:hover {
                transform: translateY(-4px);
                border-color: var(--primary);
                box-shadow: var(--shadow);
                background-color: var(--card-bg);
            }
            .card-inner {
                width: 100%; height: 100%;
                transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
                transform-style: preserve-3d;
            }
            .entry-card.flipped .card-inner { transform: rotateY(180deg); }
            .card-front, .card-back {
                position: absolute; width: 100%; height: 100%;
                -webkit-backface-visibility: hidden; backface-visibility: hidden;
                display: flex; justify-content: center; align-items: center;
                padding: 16px; box-sizing: border-box; border-radius: var(--radius-lg);
            }
            .card-back { transform: rotateY(180deg); background: var(--primary); color: white; }
            .entry-char { font-size: 44px; font-weight: 500; }
            .entry-desc { font-size: 14px; line-height: 1.5; text-align: center; }
            #loading-indicator {
                font-size: 18px;
                color: var(--text-sec);
                text-align: center;
                padding: 40px;
            }
            /* Settings Panel */
            #settings-panel {
                position: fixed; top: 0; right: -320px; width: 320px; height: 100%;
                background-color: var(--card-bg); box-shadow: var(--shadow);
                padding: 32px; box-sizing: border-box; transition: right 0.3s ease;
                z-index: 1001; border-left: 1px solid var(--border);
            }
            body.settings-panel-open #settings-panel { right: 0; }
            #settings-panel h2 { margin-top: 0; font-size: 24px; font-weight: 700; margin-bottom: 32px; }
            
            .settings-group { display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px; }
            .settings-group label { font-weight: 600; font-size: 14px; color: var(--text-sec); }
            
            #settings-close-btn {
                position: absolute; top: 24px; right: 24px; font-size: 24px;
                cursor: pointer; color: var(--text-sec); transition: color 0.2s;
            }
            #settings-close-btn:hover { color: var(--danger); }
            
            .modal-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(20px);
                display: flex; justify-content: center; align-items: center; z-index: 1000;
            }
            .modal-content {
                background-color: var(--card-bg); padding: 40px; border-radius: 28px;
                box-shadow: 0 24px 80px rgba(0, 0, 0, 0.2); width: 90%; max-width: 650px;
                position: relative; border: 1px solid var(--border);
            }
            .modal-close {
                position: absolute; top: 24px; right: 24px; font-size: 24px;
                background: rgba(0, 0, 0, 0.05); border: none; color: var(--text-sec);
                cursor: pointer; padding: 8px; border-radius: 50%;
                display: flex; align-items: center; justify-content: center; transition: all 0.2s;
            }
            .modal-close:hover { background: var(--danger); color: white; }
            
            #playground-char-container {
                height: 300px;
                background: var(--bg);
                border-radius: var(--radius-lg);
                display: flex;
                justify-content: center;
                align-items: center;
                overflow: hidden;
                position: relative;
                margin-bottom: 32px;
                border: 1px solid var(--border);
            }
            #playground-char {
                font-size: 120px;
                cursor: move;
                position: absolute;
                user-select: none;
                transition: color 0.2s;
            }
            #playground-controls {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 24px;
            }
            #playground-desc {
                font-size: 18px;
                color: var(--text-sec);
                text-align: center;
                margin-top: 24px;
                font-weight: 500;
            }
        </style>
    </head>
    <body>
        <div id="main-container">
            <div class="toolbar">
                <input
                    type="search"
                    id="search-input"
                    placeholder="搜索汉字..."
                />
                <div id="settings-btn">&#9881;</div>
            </div>
            <div id="content-area">
                <div id="combination-section">
                    <div
                        id="combination-area"
                        ondragover="event.preventDefault()"
                        ondrop="dropHandler(event)"
                    >
                        <span style="color: var(--subtext-color)"
                            >点击或拖拽汉字到此处进行组合</span
                        >
                    </div>
                    <span
                        id="clear-combination-btn"
                        onclick="clearCombination()"
                        >&times;</span
                    >
                </div>
                <div id="loading-indicator">正在加载字典...</div>
                <div id="entry-list"></div>
            </div>
        </div>

        <div id="settings-panel">
            <span id="settings-close-btn">&times;</span>
            <h2>设置</h2>
            <div class="settings-group">
                <label for="dict-selector">选择字典:</label>
                <select id="dict-selector"></select>
            </div>
            <div class="settings-group">
                <label for="sort-selector">排序方式:</label>
                <select id="sort-selector">
                    <option value="default">默认 (A-Z)</option>
                    <option value="pinyin">按拼音</option>
                    <option value="random">随机</option>
                </select>
            </div>
        </div>

        <div id="playground-modal" class="modal-overlay" style="display: none">
            <div class="modal-content">
                <span class="modal-close">&times;</span>
                <div id="playground-char-container">
                    <div id="playground-char"></div>
                </div>
                <div id="playground-controls">
                    <div class="control-group">
                        <label for="zoom-slider">Zoom:</label>
                        <input
                            type="range"
                            id="zoom-slider"
                            min="0.5"
                            max="3"
                            step="0.1"
                            value="1"
                        />
                    </div>
                    <div class="control-group">
                        <label for="rotate-slider">Rotate:</label>
                        <input
                            type="range"
                            id="rotate-slider"
                            min="0"
                            max="360"
                            step="1"
                            value="0"
                        />
                    </div>
                    <div class="control-group">
                        <label for="stretch-x-slider">Stretch X:</label>
                        <input
                            type="range"
                            id="stretch-x-slider"
                            min="0.5"
                            max="2"
                            step="0.1"
                            value="1"
                        />
                    </div>
                    <div class="control-group">
                        <label for="stretch-y-slider">Stretch Y:</label>
                        <input
                            type="range"
                            id="stretch-y-slider"
                            min="0.5"
                            max="2"
                            step="0.1"
                            value="1"
                        />
                    </div>
                    <div class="control-group">
                        <label for="color-picker">Color:</label>
                        <input type="color" id="color-picker" value="#212529" />
                    </div>
                </div>
                <div id="playground-desc"></div>
            </div>
        </div>

        <script>
            const DICTIONARIES = [
                { name: "基础字词", path: "dicts/chinese/first_dict/dict.json" },
                { name: "词组", path: "dicts/chinese/first_dict/dict_cizu.json" },
                { name: "英文短词", path: "dicts/chinese/first_dict/dict_enlt5s.json" },
                { name: "英文长词", path: "dicts/chinese/first_dict/dict_5_10s.json" },
            ];

            let currentEntries = [];
            let cizuWordMap = new Map();

            document.addEventListener("DOMContentLoaded", () => {
                const dictSelector = document.getElementById("dict-selector");
                const sortSelector = document.getElementById("sort-selector");
                const searchInput = document.getElementById("search-input");
                const settingsBtn = document.getElementById("settings-btn");
                const settingsCloseBtn =
                    document.getElementById("settings-close-btn");

                DICTIONARIES.forEach((dict) => {
                    const option = document.createElement("option");
                    option.value = dict.path;
                    option.textContent = dict.name;
                    dictSelector.appendChild(option);
                });

                dictSelector.addEventListener("change", (e) =>
                    fetchAndDisplayDictionary(e.target.value),
                );
                sortSelector.addEventListener("change", () =>
                    sortAndDisplayEntries(currentEntries),
                );
                searchInput.addEventListener("input", handleSearch);
                settingsBtn.addEventListener("click", () =>
                    document.body.classList.add("settings-panel-open"),
                );
                settingsCloseBtn.addEventListener("click", () =>
                    document.body.classList.remove("settings-panel-open"),
                );

                fetchAndDisplayDictionary(DICTIONARIES[0].path);
                fetchCizuDict();
                setupModal();

                document.body.addEventListener("click", (e) => {
                    if (!e.target.closest(".entry-char-wrapper")) {
                        deselectAllChars();
                    }
                });
            });

            async function fetchCizuDict() {
                try {
                    const response = await fetch(
                        "dicts/chinese/first_dict/dict_cizu.json",
                    );
                    if (!response.ok)
                        throw new Error("Failed to load cizu dictionary");
                    const cizuDict = await response.json();
                    for (const pinyin in cizuDict) {
                        cizuDict[pinyin].forEach((word) => {
                            if (!cizuWordMap.has(word)) {
                                cizuWordMap.set(word, pinyin);
                            }
                        });
                    }
                } catch (error) {
                    console.error(error);
                }
            }

            async function fetchAndDisplayDictionary(dictPath) {
                const list = document.getElementById("entry-list");
                const loadingIndicator =
                    document.getElementById("loading-indicator");

                list.innerHTML = "";
                loadingIndicator.style.display = "block";
                loadingIndicator.textContent = "正在加载字典...";

                try {
                    const response = await fetch(dictPath);
                    if (!response.ok)
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    const data = await response.json();

                    const entries = [];
                    for (const pinyin in data) {
                        data[pinyin].forEach((entry) => {
                            const char =
                                typeof entry === "string" ? entry : entry.char;
                            const desc =
                                typeof entry === "object" && entry.en
                                    ? entry.en
                                    : "（无解释）";
                            if (char) entries.push({ char, desc, pinyin });
                        });
                    }

                    const uniqueEntries = Array.from(
                        new Map(entries.map((e) => [e.char, e])).values(),
                    );
                    currentEntries = uniqueEntries;
                    sortAndDisplayEntries(currentEntries);
                } catch (error) {
                    console.error(
                        "Failed to load or process dictionary:",
                        error,
                    );
                    loadingIndicator.textContent =
                        "加载失败，请检查文件路径或网络连接。";
                }
            }

            function sortAndDisplayEntries(entries) {
                const list = document.getElementById("entry-list");
                const loadingIndicator =
                    document.getElementById("loading-indicator");
                const sortMethod =
                    document.getElementById("sort-selector").value;

                let sortedEntries = [...entries];

                if (sortMethod === "pinyin") {
                    sortedEntries.sort((a, b) =>
                        a.pinyin.localeCompare(
                            b.pinyin,
                            "zh-Hans-CN-u-co-pinyin",
                        ),
                    );
                } else if (sortMethod === "random") {
                    sortedEntries.sort(() => Math.random() - 0.5);
                } else {
                    // default
                    sortedEntries.sort((a, b) =>
                        a.char.localeCompare(b.char, "zh-Hans-CN"),
                    );
                }

                list.innerHTML = "";
                loadingIndicator.style.display = "none";

                const fragment = document.createDocumentFragment();
                sortedEntries.forEach((entry) => {
                    const card = document.createElement("div");
                    card.className = "entry-card";
                    card.draggable = true;
                    card.dataset.char = entry.char;

                    const cardInner = document.createElement("div");
                    cardInner.className = "card-inner";

                    const cardFront = document.createElement("div");
                    cardFront.className = "card-front";
                    const charEl = document.createElement("div");
                    charEl.className = "entry-char";
                    charEl.textContent = entry.char;

                    const cardBack = document.createElement("div");
                    cardBack.className = "card-back";
                    const descEl = document.createElement("div");
                    descEl.className = "entry-desc";
                    descEl.textContent = entry.desc;

                    cardFront.appendChild(charEl);
                    cardBack.appendChild(descEl);
                    cardInner.appendChild(cardFront);
                    cardInner.appendChild(cardBack);
                    card.appendChild(cardInner);

                    card.addEventListener("click", () =>
                        addCharToCombination(entry.char),
                    );
                    card.addEventListener("dblclick", (e) => {
                        e.preventDefault();
                        card.classList.toggle("flipped");
                    });
                    card.addEventListener("dragstart", dragStartHandler);

                    fragment.appendChild(card);
                });
                list.appendChild(fragment);
            }

            function handleSearch(event) {
                const query = event.target.value.toLowerCase();
                const cards = document.querySelectorAll(".entry-card");
                cards.forEach((card) => {
                    const char = card
                        .querySelector(".entry-char")
                        .textContent.toLowerCase();
                    card.style.display = char.includes(query) ? "flex" : "none";
                });
            }

            function addCharToCombination(char) {
                const combinationArea =
                    document.getElementById("combination-area");
                if (
                    combinationArea.children.length === 1 &&
                    combinationArea.children[0].tagName === "SPAN"
                ) {
                    combinationArea.innerHTML = ""; // Clear placeholder
                }

                const charWrapper = document.createElement("div");
                charWrapper.className = "entry-char-wrapper";
                charWrapper.dataset.scale = 1;
                charWrapper.dataset.rotation = 0;

                const charEl = document.createElement("div");
                charEl.className = "entry-char";
                charEl.style.fontSize = "28px";
                charEl.textContent = char;

                charWrapper.appendChild(charEl);
                combinationArea.appendChild(charWrapper);

                charWrapper.addEventListener("click", (e) => {
                    e.stopPropagation();
                    selectChar(charWrapper);
                });

                checkCombination();
            }

            function selectChar(charWrapper) {
                deselectAllChars();
                charWrapper.classList.add("selected");
                createCharToolbar(charWrapper);
            }

            function deselectAllChars() {
                document
                    .querySelectorAll(".entry-char-wrapper.selected")
                    .forEach((el) => {
                        el.classList.remove("selected");
                    });
                document
                    .querySelectorAll(".char-toolbar")
                    .forEach((toolbar) => toolbar.remove());
            }

            function createCharToolbar(charWrapper) {
                const toolbar = document.createElement("div");
                toolbar.className = "char-toolbar";

                const zoomInBtn = document.createElement("button");
                zoomInBtn.textContent = "+";
                zoomInBtn.onclick = () => {
                    let scale = parseFloat(charWrapper.dataset.scale) + 0.1;
                    charWrapper.dataset.scale = scale;
                    charWrapper.style.transform = `scale(${scale}) rotate(${charWrapper.dataset.rotation}deg)`;
                };

                const zoomOutBtn = document.createElement("button");
                zoomOutBtn.textContent = "-";
                zoomOutBtn.onclick = () => {
                    let scale = parseFloat(charWrapper.dataset.scale) - 0.1;
                    charWrapper.dataset.scale = scale;
                    charWrapper.style.transform = `scale(${scale}) rotate(${charWrapper.dataset.rotation}deg)`;
                };

                const rotateBtn = document.createElement("button");
                rotateBtn.innerHTML = "&#8635;";
                rotateBtn.onclick = () => {
                    let rotation = parseInt(charWrapper.dataset.rotation) + 15;
                    charWrapper.dataset.rotation = rotation;
                    charWrapper.style.transform = `scale(${charWrapper.dataset.scale}) rotate(${rotation}deg)`;
                };

                const deleteBtn = document.createElement("button");
                deleteBtn.innerHTML = "&times;";
                deleteBtn.onclick = () => {
                    charWrapper.remove();
                    checkCombination();
                };

                toolbar.appendChild(zoomInBtn);
                toolbar.appendChild(zoomOutBtn);
                toolbar.appendChild(rotateBtn);
                toolbar.appendChild(deleteBtn);
                charWrapper.appendChild(toolbar);
            }

            // Drag and Drop for combination
            function dragStartHandler(event) {
                event.dataTransfer.setData(
                    "text/plain",
                    event.target.dataset.char,
                );
                event.dataTransfer.effectAllowed = "copy";
            }

            function dropHandler(event) {
                event.preventDefault();
                const char = event.dataTransfer.getData("text/plain");
                addCharToCombination(char);
            }

            function checkCombination() {
                const combinationArea =
                    document.getElementById("combination-area");
                const pinyinDisplay =
                    document.getElementById("combination-pinyin");
                if (pinyinDisplay) pinyinDisplay.remove();

                const chars = Array.from(
                    combinationArea.querySelectorAll(".entry-char"),
                )
                    .map((el) => el.textContent)
                    .join("");

                if (chars.length > 0) {
                    if (cizuWordMap.has(chars)) {
                        combinationArea.classList.add("valid");
                        combinationArea.classList.remove("invalid");
                        const pinyin = cizuWordMap.get(chars);
                        const pinyinEl = document.createElement("span");
                        pinyinEl.id = "combination-pinyin";
                        pinyinEl.textContent = pinyin;
                        combinationArea.appendChild(pinyinEl);
                    } else {
                        combinationArea.classList.add("invalid");
                        combinationArea.classList.remove("valid");
                    }
                } else {
                    clearCombination();
                }
            }

            function clearCombination() {
                const combinationArea =
                    document.getElementById("combination-area");
                combinationArea.innerHTML =
                    '<span style="color: var(--subtext-color);">点击或拖拽汉字到此处进行组合</span>';
                combinationArea.classList.remove("valid", "invalid");
            }

            function setupModal() {
                const modal = document.getElementById("playground-modal");
                const closeModalBtn = document.querySelector(".modal-close");
                const playgroundChar =
                    document.getElementById("playground-char");
                const zoomSlider = document.getElementById("zoom-slider");
                const rotateSlider = document.getElementById("rotate-slider");
                const stretchXSlider =
                    document.getElementById("stretch-x-slider");
                const stretchYSlider =
                    document.getElementById("stretch-y-slider");
                const colorPicker = document.getElementById("color-picker");

                closeModalBtn.onclick = () => (modal.style.display = "none");
                window.onclick = (event) => {
                    if (event.target == modal) modal.style.display = "none";
                };

                let scale = 1,
                    rotation = 0,
                    scaleX = 1,
                    scaleY = 1;

                const updateTransform = () => {
                    playgroundChar.style.transform = `translate(-50%, -50%) scale(${scale}) rotate(${rotation}deg) scaleX(${scaleX}) scaleY(${scaleY})`;
                };

                zoomSlider.oninput = (e) => {
                    scale = e.target.value;
                    updateTransform();
                };
                rotateSlider.oninput = (e) => {
                    rotation = e.target.value;
                    updateTransform();
                };
                stretchXSlider.oninput = (e) => {
                    scaleX = e.target.value;
                    updateTransform();
                };
                stretchYSlider.oninput = (e) => {
                    scaleY = e.target.value;
                    updateTransform();
                };
                colorPicker.oninput = (e) =>
                    (playgroundChar.style.color = e.target.value);

                // Drag and Drop for modal character
                let isDragging = false,
                    offsetX,
                    offsetY;
                const container = document.getElementById(
                    "playground-char-container",
                );
                playgroundChar.addEventListener("mousedown", (e) => {
                    isDragging = true;
                    const rect = playgroundChar.getBoundingClientRect();
                    const containerRect = container.getBoundingClientRect();
                    offsetX = e.clientX - rect.left + containerRect.left;
                    offsetY = e.clientY - rect.top + containerRect.top;
                    playgroundChar.style.cursor = "grabbing";
                });
                document.addEventListener("mousemove", (e) => {
                    if (!isDragging) return;
                    let x = e.clientX - offsetX;
                    let y = e.clientY - offsetY;
                    playgroundChar.style.left = `${x}px`;
                    playgroundChar.style.top = `${y}px`;
                });
                document.addEventListener("mouseup", () => {
                    isDragging = false;
                    playgroundChar.style.cursor = "move";
                });
            }

            function openModal(entry) {
                const modal = document.getElementById("playground-modal");
                const playgroundChar =
                    document.getElementById("playground-char");
                const playgroundDesc =
                    document.getElementById("playground-desc");

                document.getElementById("zoom-slider").value = 1;
                document.getElementById("rotate-slider").value = 0;
                document.getElementById("stretch-x-slider").value = 1;
                document.getElementById("stretch-y-slider").value = 1;
                document.getElementById("color-picker").value = "#212529";

                playgroundChar.textContent = entry.char;
                playgroundDesc.textContent = entry.desc;

                playgroundChar.style.color = "#212529";
                playgroundChar.style.left = "50%";
                playgroundChar.style.top = "50%";
                playgroundChar.style.transform =
                    "translate(-50%, -50%) scale(1) rotate(0deg) scaleX(1) scaleY(1)";

                modal.style.display = "flex";
            }
        </script>
    </body>
</html>
